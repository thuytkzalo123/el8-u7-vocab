<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gamified Cloze Test System - 3 Levels</title>
    <style>
        /* --- 1. SETUP BI·∫æN M√ÄU & C·∫§U H√åNH CHUNG --- */
        :root {
            --primary-color: #007bff;       /* Xanh d∆∞∆°ng */
            --success-color: #28a745;       /* Xanh l√° */
            --error-color: #dc3545;         /* ƒê·ªè */
            --highlight-color: #ffd700;     /* V√†ng Gold - D√πng cho Hint 2 */
            --bg-color: #f4f6f9;
            --text-color: #333;
            --white: #ffffff;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { margin: 0; padding: 20px; background-color: var(--bg-color); color: var(--text-color); }

        /* --- PASSWORD OVERLAY --- */
        #password-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white;
        }
        #password-input { padding: 10px; font-size: 1.2rem; border-radius: 5px; border: none; margin-bottom: 10px; }
        #password-btn { padding: 10px 20px; font-size: 1rem; background: var(--primary-color); color: white; border: none; border-radius: 5px; cursor: pointer; }
        
        /* --- 2. LAYOUT FLEXBOX (2 C·ªòT) --- */
        .container {
            display: flex;
            flex-wrap: wrap; 
            justify-content: center;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
            opacity: 0; transition: opacity 1s; 
        }
        .container.visible { opacity: 1; }

        /* --- C·ªòT TR√ÅI: ƒêO·∫†N VƒÇN --- */
        .text-panel {
            flex: 0 0 750px; max-width: 100%;
            background: var(--white); padding: 30px; border-radius: 8px;
            box-shadow: var(--shadow); font-size: 1.1rem; line-height: 1.8;
            height: fit-content;
        }

        /* --- C·ªòT PH·∫¢I: B·∫¢NG C√ÇU H·ªéI (STICKY) --- */
        .question-panel {
            flex: 0 0 450px; max-width: 100%;
            background: var(--white); padding: 20px; border-radius: 8px;
            box-shadow: var(--shadow);
            position: sticky; top: 20px;
            height: fit-content; max-height: 95vh; overflow-y: auto;
        }

        @media (max-width: 1250px) {
            .container { flex-direction: column; align-items: center; }
            .text-panel, .question-panel { flex: 1; width: 100%; max-width: 800px; }
            .question-panel { position: static; height: auto; }
        }

        /* --- ELEMENTS --- */
        .gap {
            display: inline-block; min-width: 50px;
            border-bottom: 2px solid var(--primary-color);
            color: var(--primary-color); font-weight: bold;
            text-align: center; cursor: pointer; padding: 0 5px;
            transition: all 0.3s;
        }
        .gap:hover, .gap.active { background-color: #eef7ff; border-radius: 4px; }
        .gap.correct { color: var(--success-color); border-bottom-color: var(--success-color); }
        .gap.wrong { color: var(--error-color); border-bottom-color: var(--error-color); text-decoration: line-through; }

        .signal-word { transition: background-color 0.5s ease; border-radius: 3px; padding: 0 2px; }
        .signal-word.highlighted { background-color: var(--highlight-color); font-weight: bold; color: black; }

        /* HEADER SCORE */
        .header-score {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #eee;
        }
        .score-display { font-size: 1.2rem; font-weight: bold; color: var(--primary-color); }

        /* OPTIONS GRID */
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .option-btn {
            padding: 12px; border: 1px solid #ddd; background: white;
            border-radius: 6px; cursor: pointer; font-size: 1rem;
            transition: all 0.2s; text-align: left;
        }
        .option-btn:hover:not(:disabled) { background-color: #f0f0f0; }
        
        /* TR·∫†NG TH√ÅI ƒê√ÅP √ÅN (CH·ªÆ TR·∫ÆNG) */
        .option-btn.correct-select { 
            background-color: var(--success-color) !important; 
            color: white !important; 
            border-color: var(--success-color) !important;
            font-weight: bold;
        }
        .option-btn.wrong-select { 
            background-color: var(--error-color) !important; 
            color: white !important; 
            border-color: var(--error-color) !important;
            font-weight: bold;
        }
        .option-btn.reveal-correct { 
            border: 2px solid var(--success-color); 
            color: var(--success-color); 
            font-weight: bold;
            position: relative;
        }
        .option-btn.reveal-correct::after {
            content: "‚úì"; position: absolute; right: 10px; font-weight: bold;
        }
        .option-btn:disabled { cursor: default; opacity: 0.9; }

        /* HINTS */
        .hints-container { display: flex; flex-direction: column; gap: 8px; }
        .hint-btn {
            width: 100%; text-align: left; padding: 10px;
            background: #f8f9fa; border: 1px solid #eee; border-radius: 5px;
            cursor: pointer; font-weight: 600; color: #555;
            display: flex; justify-content: space-between;
        }
        .hint-btn:hover:not(:disabled) { background: #e2e6ea; }
        .hint-btn:disabled { opacity: 0.5; cursor: not-allowed; background: #eee; }
        
        .hint-cost { font-size: 0.8em; color: var(--error-color); }
        .hint-content {
            padding: 10px; background: #fff; display: none;
            border: 1px solid #eee; border-top: none;
            font-size: 0.95rem; color: #444; line-height: 1.5;
        }
        .hint-content.show { display: block; animation: fadeIn 0.3s; }

        /* NEXT BUTTON */
        .nav-btn {
            margin-top: 20px; width: 100%; padding: 15px;
            background: var(--primary-color); color: white;
            border: none; border-radius: 5px; font-size: 1.1rem; font-weight: bold;
            cursor: pointer; display: none; 
        }
        .nav-btn:hover { background: #0056b3; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="password-overlay">
        <h2>üîí Y√™u c·∫ßu M·∫≠t kh·∫©u</h2>
        <p>Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ truy c·∫≠p 3 b√†i Cloze Test (G·ª£i √Ω: 1234)</p>
        <input type="password" id="password-input" placeholder="Nh·∫≠p m·∫≠t kh·∫©u...">
        <button id="password-btn" onclick="app.checkPassword()">V√†o l√†m b√†i</button>
        <p id="pass-error" style="color: #ff6b6b; display: none; margin-top: 10px;">M·∫≠t kh·∫©u sai!</p>
    </div>

    <div class="container" id="main-container">
        <div class="text-panel">
            <h2 id="ex-title">Loading...</h2>
            <div id="ex-content"></div>
        </div>

        <div class="question-panel">
            <div class="header-score">
                <span>Cloze Test Series</span>
                <span class="score-display">
                    Score: <span id="current-score">0</span> / <span id="max-score">0</span>
                </span>
            </div>

            <div id="game-area">
                <div style="text-align: center; color: #888; padding: 20px;">
                    H√£y ch·ªçn m·ªôt √¥ tr·ªëng b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu.
                </div>
            </div>

            <button id="next-ex-btn" class="nav-btn" onclick="app.nextExercise()">
                Chuy·ªÉn sang b√†i ti·∫øp theo ‚û°
            </button>
        </div>
    </div>

    <script>
        // --- DATA STORE (3 ƒê·ªÄ M·ªöI) ---
        const exercises = [
            {
                id: 1,
                title: "ƒê·ªÅ 1: Food Fair Advertisement",
                content: `
                    <h3 style="margin-top:0">Discover the Best of Hai Phong at Our Food Fair!</h3>
                    <p>
                        Join us this weekend for the Hai Duong Food Fair! Taste a variety of delicious dishes made from <span id="sig-1-17-2" class="signal-word">fresh</span>, 
                        <span id="gap-1-17" class="gap" onclick="app.selectQuestion(1, 17)">(17) ______</span> 
                        <span id="sig-1-17-2" class="signal-word">ingredients</span>. 
                        From traditional Vietnamese cuisine to modern fusion, there's something for everyone. Whether you want to enjoy your meal here or take way, we've got you covered.
                    </p>
                    <p>
                        This event is a great opportunity 
                        <span id="gap-1-18" class="gap" onclick="app.selectQuestion(1, 18)">(18) ______</span> 
                        <span id="sig-1-18-2" class="signal-word">local products</span> 
                        and support small businesses. Don't miss out on the fun activities, cooking demonstrations, and special discounts. 
                        Bring your friends and family for a(n) 
                        <span id="gap-1-19" class="gap" onclick="app.selectQuestion(1, 19)">(19) ______</span> 
                        <span id="sig-1-19-2" class="signal-word">experience</span>!
                    </p>
                `,
                questions: [
                    {
                        id: 17,
                        options: [{id: "A", text: "basic"}, {id: "B", text: "dedicated"}, {id: "C", text: "full"}, {id: "D", text: "starter"}],
                        correct: "A",
                        signalElementIds: ["sig-1-17-2"], // ingredients
                        hints: [
                            "Hint 1 (Enemy): 4 t·ª´ kh√°c nghƒ©a ho√†n to√†n. ƒê√¢y l√† b√†i t·∫≠p v·ªÅ T·ª™ V·ª∞NG/K·∫æT H·ª¢P T·ª™.",
                            "Hint 2 (Signal): H√£y nh√¨n v√†o t√≠nh t·ª´ 'fresh' ph√≠a tr∆∞·ªõc + danh t·ª´ 'ingredients' (nguy√™n li·ªáu) ƒë·ª©ng sau.",
                            "Hint 3 (Logic): C·∫ßn m·ªôt t√≠nh t·ª´ ph√π h·ª£p ƒë·ªÉ m√¥ t·∫£ 'ingredients' (nguy√™n li·ªáu).",
                            "Hint 4 (Trans):<br>A. [c∆° b·∫£n] + nguy√™n li·ªáu<br>B. [t·∫≠n t·ª•y] + nguy√™n li·ªáu<br>C. [ƒë·∫ßy] + nguy√™n li·ªáu<br>D. [khai v·ªã] + nguy√™n li·ªáu"
                        ]
                    },
                    {
                        id: 18,
                        options: [{id: "A", text: "contribute"}, {id: "B", text: "promote"}, {id: "C", text: "invite"}, {id: "D", text: "occupy"}],
                        correct: "B",
                        signalElementIds: ["sig-1-18-2"], // local products
                        hints: [
                            "Hint 1 (Enemy): 4 ƒê·ªông t·ª´ kh√°c nhau. B√†i t·∫≠p NG·ªÆ NGHƒ®A.",
                            "Hint 2 (Signal): Danh t·ª´ 'local products' (s·∫£n ph·∫©m ƒë·ªãa ph∆∞∆°ng) ƒë·ª©ng sau.",
                            "Hint 3 (Logic): M·ª•c ƒë√≠ch c·ªßa 'fair' h·ªôi ch·ª£ l√† ƒë·ªÉ l√†m g√¨.",
                            "Hint 4 (Trans):<br>A. [ƒë√≥ng g√≥p] + s·∫£n ph·∫©m ƒë·ªãa ph∆∞∆°ng<br>B. [qu·∫£ng b√°] + s·∫£n ph·∫©m ƒë·ªãa ph∆∞∆°ng<br>C. [m·ªùi] + s·∫£n ph·∫©m ƒë·ªãa ph∆∞∆°ng<br>D. [chi·∫øm gi·ªØ] + s·∫£n ph·∫©m ƒë·ªãa ph∆∞∆°ng"
                        ]
                    },
                    {
                        id: 19,
                        options: [{id: "A", text: "unforgettable"}, {id: "B", text: "forget"}, {id: "C", text: "forgetful"}, {id: "D", text: "forgettably"}],
                        correct: "A",
                        signalElementIds: ["sig-1-19-2"], // experience
                        hints: [
                            "Hint 1 (Enemy): 4 t·ª´ c√πng g·ªëc 'forget'. B√†i t·∫≠p T·ª™ LO·∫†I.",
                            "Hint 2 (Signal): M·∫°o t·ª´ 'a(n)' ƒë·ª©ng tr∆∞·ªõc v√† Danh t·ª´ 'experience' ƒë·ª©ng sau.",
                            "Hint 3 (Logic): V·ªã tr√≠ n√†y c·∫ßn m·ªôt T√≠nh t·ª´ b·ªï nghƒ©a cho danh t·ª´.",
                            "Hint 4 (Trans):<br>A. [ƒë√°ng nh·ªõ/kh√¥ng th·ªÉ qu√™n] + tr·∫£i nghi·ªám<br>B. [qu√™n] + tr·∫£i nghi·ªám<br>C. [hay qu√™n] + tr·∫£i nghi·ªám<br>D. [m·ªôt c√°ch d·ªÖ qu√™n] + tr·∫£i nghi·ªám"
                        ]
                    }
                ]
            },
            {
                id: 2,
                title: "ƒê·ªÅ 2: Community Clean-up Day",
                content: `
                    <h3 style="margin-top:0">Community Clean-up Day!</h3>
                    <p>
                        Join us for our annual Community Clean-up Day on Saturday... 
                        Our goal is to make our neighborhood a cleaner and greener place. 
                        Gloves, trash bags, and tools will be 
                        <span id="gap-2-17" class="gap" onclick="app.selectQuestion(2, 17)">(17) ______</span>.
                        <span id="sig-2-17-prev" class="signal-word" style="display:none">will be</span> 
                    </p>
                    <p>
                        This is a great opportunity to 
                        <span id="gap-2-18" class="gap" onclick="app.selectQuestion(2, 18)">(18) ______</span> 
                        <span id="sig-2-18-2" class="signal-word">your neighbors</span> 
                        and contribute to a healthier environment. 
                        To register or for more information, please visit our website... We look forward to 
                        <span id="gap-2-19" class="gap" onclick="app.selectQuestion(2, 19)">(19) ______</span> 
                        <span id="sig-2-19-2" class="signal-word">you</span> there!
                    </p>
                `,
                questions: [
                    {
                        id: 17,
                        options: [{id: "A", text: "supplied"}, {id: "B", text: "provided"}, {id: "C", text: "given"}, {id: "D", text: "offered"}],
                        correct: "B",
                        signalElementIds: [], // Kh√¥ng c√≥ signal word c·ª• th·ªÉ b√¥i ƒëen r√µ r√†ng ngo√†i ng·ªØ c·∫£nh c√¢u
                        hints: [
                            "Hint 1 (Enemy): 4 ƒê·ªông t·ª´ d·∫°ng b·ªã ƒë·ªông (V3). B√†i t·∫≠p T·ª™ V·ª∞NG/NG·ªÆ NGHƒ®A.",
                            "Hint 2 (Signal): Ch·ªß ng·ªØ l√† 'Tools/Gloves' (d·ª•ng c·ª•).",
                            "Hint 3 (Logic): D·ª•ng c·ª• s·∫Ω ƒë∆∞·ª£c ... cho t√¨nh nguy·ªán vi√™n s·ª≠ d·ª•ng.",
                            "Hint 4 (Trans):<br>A. [ƒë∆∞·ª£c ti·∫øp t·∫ø] <br>B. [ƒë∆∞·ª£c cung c·∫•p] (d√πng cho v·∫≠t d·ª•ng)<br>C. [ƒë∆∞·ª£c t·∫∑ng/cho]<br>D. [ƒë∆∞·ª£c m·ªùi ch√†o]"
                        ]
                    },
                    {
                        id: 18,
                        options: [{id: "A", text: "join"}, {id: "B", text: "know"}, {id: "C", text: "unite"}, {id: "D", text: "meet"}],
                        correct: "D",
                        signalElementIds: ["sig-2-18-2"], // your neighbors
                        hints: [
                            "Hint 1 (Enemy): 4 ƒê·ªông t·ª´ th∆∞·ªùng. B√†i t·∫≠p NG·ªÆ NGHƒ®A.",
                            "Hint 2 (Signal): ƒê·ªëi t∆∞·ª£ng ph√≠a sau l√† 'your neighbors' (h√†ng x√≥m).",
                            "Hint 3 (Logic): Ch√∫ng ta ... h√†ng x√≥m.",
                            "Hint 4 (Trans):<br>A. [tham gia] + h√†ng x√≥m<br>B. [bi·∫øt] + h√†ng x√≥m<br>C. [th·ªëng nh·∫•t] + h√†ng x√≥m<br>D. [g·∫∑p g·ª°] + h√†ng x√≥m"
                        ]
                    },
                    {
                        id: 19,
                        options: [{id: "A", text: "see"}, {id: "B", text: "seeing"}, {id: "C", text: "to see"}, {id: "D", text: "saw"}],
                        correct: "B",
                        signalElementIds: ["sig-2-19-2"], // you
                        hints: [
                            "Hint 1 (Enemy): C√°c d·∫°ng c·ªßa ƒë·ªông t·ª´ 'See'. B√†i t·∫≠p NG·ªÆ PH√ÅP (Verb Form).",
                            "Hint 2 (Signal): H√£y nh√¨n c·ª•m t·ª´ c·ªë ƒë·ªãnh ƒë·ª©ng tr∆∞·ªõc: 'look forward to'.",
                            "Hint 3 (Logic): C·∫•u tr√∫c: Look forward to + V_ing(Mong ch·ªù l√†m g√¨ ƒë√≥).",
                            "Hint 4 (Trans):<br>A. see (V-inf)<br>B. seeing (V-ing)<br>C. to see (To V)<br>D. saw (V-ed)"
                        ]
                    }
                ]
            },
            {
                id: 3,
                title: "ƒê·ªÅ 3: Independence Day Discount",
                content: `
                    <h3 style="margin-top:0">SPECIAL MOVIE TICKET DISCOUNT</h3>
                    <p>
                        To celebrate Vietnam's Independence Day... This offer is valid for all movies at 
                        <span id="gap-3-17" class="gap" onclick="app.selectQuestion(3, 17)">(17) ______</span> 
                        <span id="sig-3-17-2" class="signal-word">cinema</span>. 
                    </p>
                    <p>
                        If you are not sure 
                        <span id="gap-3-18" class="gap" onclick="app.selectQuestion(3, 18)">(18) ______</span> 
                        <span id="sig-3-18-2" class="signal-word">to get</span> 
                        the tickets online, please visit our website...
                    </p>
                    <p>
                        Join us on this national holiday and enjoy wonderful movies at a very reasonable 
                        <span id="gap-3-19" class="gap" onclick="app.selectQuestion(3, 19)">(19) ______</span>.
                        <span id="sig-3-19-prev" class="signal-word" style="display:none">reasonable</span>
                    </p>
                `,
                questions: [
                    {
                        id: 17,
                        options: [{id: "A", text: "a"}, {id: "B", text: "the"}, {id: "C", text: "an"}, {id: "D", text: "√ò"}],
                        correct: "B",
                        signalElementIds: ["sig-3-17-2"], // cinema
                        hints: [
                            "Hint 1 (Enemy): C√°c M·∫°o t·ª´. B√†i t·∫≠p NG·ªÆ PH√ÅP.",
                            "Hint 2 (Signal): Danh t·ª´ 'cinema' v√† ng·ªØ c·∫£nh b√†i vi·∫øt ('our cinema' ·ªü c√¢u ƒë·∫ßu).",
                            "Hint 3 (Logic): R·∫°p phim n√†y ƒë√£ ƒë∆∞·ª£c x√°c ƒë·ªãnh (c·ªßa ng∆∞·ªùi vi·∫øt th√¥ng b√°o).",
                            "Hint 4 (Trans):<br>A. m·ªôt (r·∫°p n√†o ƒë√≥)<br>B. r·∫°p n√†y (x√°c ƒë·ªãnh)<br>C. m·ªôt (d√πng tr∆∞·ªõc nguy√™n √¢m)<br>D. r·ªóng"
                        ]
                    },
                    {
                        id: 18,
                        options: [{id: "A", text: "how"}, {id: "B", text: "what"}, {id: "C", text: "when"}, {id: "D", text: "why"}],
                        correct: "A",
                        signalElementIds: ["sig-3-18-2"], // to get
                        hints: [
                            "Hint 1 (Enemy): T·ª´ ƒë·ªÉ h·ªèi (Wh-words). B√†i t·∫≠p C·∫§U TR√öC.",
                            "Hint 2 (Signal): ƒê·ªông t·ª´ 'to get' ph√≠a sau v√† ng·ªØ c·∫£nh 'instructions' (h∆∞·ªõng d·∫´n).",
                            "Hint 3 (Logic): H∆∞·ªõng d·∫´n th√¨ ph·∫£i l√† v·ªÅ 'c√°ch th·ª©c'.",
                            "Hint 4 (Trans):<br>A. [l√†m th·∫ø n√†o] + ƒë·ªÉ mua v√©<br>B. [c√°i g√¨] + ƒë·ªÉ mua v√©<br>C. [khi n√†o] + ƒë·ªÉ mua v√©<br>D. [t·∫°i sao] + ƒë·ªÉ mua v√©"
                        ]
                    },
                    {
                        id: 19,
                        options: [{id: "A", text: "price"}, {id: "B", text: "pricey"}, {id: "C", text: "priceless"}, {id: "D", text: "pricing"}],
                        correct: "A",
                        signalElementIds: [], // Signal l√† "reasonable" ƒë·ª©ng tr∆∞·ªõc (nh∆∞ng trong code n√†y gap click v√†o m·ªõi hi·ªán hint)
                        hints: [
                            "Hint 1 (Enemy): C√°c t·ª´ c√πng g·ªëc 'price'. B√†i t·∫≠p T·ª™ LO·∫†I.",
                            "Hint 2 (Signal): T√≠nh t·ª´ 'reasonable' (h·ª£p l√Ω) ƒë·ª©ng ngay tr∆∞·ªõc.",
                            "Hint 3 (Logic): Sau t√≠nh t·ª´ c·∫ßn m·ªôt Danh t·ª´.",
                            "Hint 4 (Trans):<br>A. [gi√° c·∫£] (Danh t·ª´)<br>B. [ƒë·∫Øt ƒë·ªè] (T√≠nh t·ª´)<br>C. [v√¥ gi√°] (T√≠nh t·ª´)<br>D. [vi·ªác ƒë·ªãnh gi√°] (Danh ƒë·ªông t·ª´)"
                        ]
                    }
                ]
            }
        ];

        // --- CONTROLLER ---
        const app = {
            state: {
                currentExIndex: 0,
                currentScore: 0,
                maxScore: 0, 
                questionsMap: {}, 
            },

            // 1. PASSWORD CHECK
            checkPassword: function() {
                const pass = document.getElementById('password-input').value;
                if (pass === "1234") {
                    document.getElementById('password-overlay').style.display = 'none';
                    document.getElementById('main-container').classList.add('visible');
                    this.initExercise(0);
                } else {
                    document.getElementById('pass-error').style.display = 'block';
                }
            },

            // 2. KH·ªûI T·∫†O B√ÄI T·∫¨P
            initExercise: function(index) {
                if (index >= exercises.length) {
                    alert("Ch√∫c m·ª´ng! B·∫°n ƒë√£ ho√†n th√†nh t·∫•t c·∫£ b√†i t·∫≠p.");
                    return;
                }

                this.state.currentExIndex = index;
                const exData = exercises[index];

                // C·∫≠p nh·∫≠t giao di·ªán Text
                document.getElementById('ex-title').innerText = exData.title;
                document.getElementById('ex-content').innerHTML = exData.content;
                document.getElementById('game-area').innerHTML = '<div style="text-align:center; color:#888; padding:20px;">Ch·ªçn √¥ tr·ªëng ƒë·ªÉ b·∫Øt ƒë·∫ßu.</div>';
                
                // N√∫t Next
                const btn = document.getElementById('next-ex-btn');
                btn.style.display = 'none';

                // Reset map c√¢u h·ªèi cho b√†i m·ªõi (Gi·ªØ l·∫°i ƒëi·ªÉm c≈©, ch·ªâ c·ªông th√™m maxScore)
                // L∆∞u √Ω: ID c√¢u h·ªèi trong data l·∫∑p l·∫°i (17,18,19), n√™n c·∫ßn key unique: `exIndex-qId`
                exData.questions.forEach(q => {
                    const uniqueKey = `${index}-${q.id}`;
                    this.state.questionsMap[uniqueKey] = {
                        answered: false,
                        points: 5,
                        hintsOpened: [false, false, false, false],
                        userAnswer: null
                    };
                    this.state.maxScore += 5;
                });
                
                this.updateScoreDisplay();
            },

            // 3. CH·ªåN C√ÇU H·ªéI
            selectQuestion: function(exId, qId) {
                // exId truy·ªÅn v√†o t·ª´ HTML l√† s·ªë th·ª© t·ª± b√†i (1, 2, 3), ƒë·ªïi v·ªÅ index (0, 1, 2)
                const realExIndex = exId - 1; 
                
                // Highlight gap
                document.querySelectorAll('.gap').forEach(el => el.classList.remove('active'));
                const activeGap = document.getElementById(`gap-${exId}-${qId}`);
                if(activeGap) activeGap.classList.add('active');

                this.renderGamePanel(realExIndex, qId);
            },

            // 4. RENDER B·∫¢NG C√ÇU H·ªéI
            renderGamePanel: function(exIndex, qId) {
                const exData = exercises[exIndex];
                const qData = exData.questions.find(q => q.id === qId);
                const uniqueKey = `${exIndex}-${qId}`;
                const qState = this.state.questionsMap[uniqueKey];
                const panel = document.getElementById('game-area');

                if (!qData) return;

                // X·ª≠ l√Ω logic Hint 2 (Highlight l·∫°i n·∫øu ƒë√£ m·ªü)
                document.querySelectorAll('.signal-word').forEach(el => el.classList.remove('highlighted'));
                if (qState.hintsOpened[1]) { 
                    qData.signalElementIds.forEach(id => {
                         const el = document.getElementById(id);
                         if(el) el.classList.add('highlighted');
                    });
                }

                let html = `
                    <div class="current-q-info">
                        <div style="font-weight:bold; margin-bottom:5px;">Question ${qId}</div>
                        <div style="font-size:0.9rem; color:#666;">
                            ƒêi·ªÉm: <b style="color:${qState.answered ? (qState.points > 0 ? 'var(--success-color)' : 'var(--error-color)') : 'var(--primary-color)'}">
                                ${qState.answered ? (qState.points > 0 ? '+' + qState.points : '0') : qState.points}
                            </b>
                        </div>
                    </div>

                    <div class="options-grid">
                        ${qData.options.map(opt => {
                            let btnClass = 'option-btn';
                            let disabled = '';
                            if (qState.answered) {
                                disabled = 'disabled';
                                if (opt.id === qData.correct) btnClass += ' reveal-correct';
                                if (opt.id === qState.userAnswer) {
                                    btnClass += (opt.id === qData.correct) ? ' correct-select' : ' wrong-select';
                                }
                            }
                            return `<button class="${btnClass}" ${disabled} onclick="app.submitAnswer(${exIndex}, ${qId}, '${opt.id}')">${opt.id}. ${opt.text}</button>`;
                        }).join('')}
                    </div>

                    <div class="hints-container">
                        <div style="font-size:0.9rem; font-weight:bold; margin-bottom:5px; color:#555;">G·ª£i √Ω (M·ªü theo th·ª© t·ª±):</div>
                        ${qData.hints.map((hintText, index) => {
                            const isOpened = qState.hintsOpened[index];
                            const isLocked = index > 0 && !qState.hintsOpened[index - 1];
                            const disabledAttr = (qState.answered || isLocked) && !isOpened ? 'disabled' : '';

                            return `
                                <div class="hint-item">
                                    <button class="hint-btn" ${disabledAttr} onclick="app.openHint(${exIndex}, ${qId}, ${index})">
                                        <span>${isOpened ? 'üìñ Hint ' + (index+1) : (isLocked ? 'üîí Locked' : 'üîê M·ªü Hint ' + (index+1))}</span>
                                        <span class="hint-cost">${isOpened || qState.answered ? '' : '-1 Point'}</span>
                                    </button>
                                    <div class="hint-content ${isOpened ? 'show' : ''}">${hintText}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                panel.innerHTML = html;
            },

            // 5. X·ª¨ L√ù HINT
            openHint: function(exIndex, qId, hintIndex) {
                const uniqueKey = `${exIndex}-${qId}`;
                const qState = this.state.questionsMap[uniqueKey];
                
                if (hintIndex > 0 && !qState.hintsOpened[hintIndex - 1]) {
                    alert("B·∫°n ph·∫£i m·ªü g·ª£i √Ω tr∆∞·ªõc ƒë√≥ tr∆∞·ªõc!");
                    return;
                }
                
                if (!qState.answered && !qState.hintsOpened[hintIndex]) {
                    if (qState.points > 0) qState.points -= 1;
                    qState.hintsOpened[hintIndex] = true;
                    this.renderGamePanel(exIndex, qId);
                }
            },

            // 6. X·ª¨ L√ù TR·∫¢ L·ªúI
            submitAnswer: function(exIndex, qId, selectedOptId) {
                const uniqueKey = `${exIndex}-${qId}`;
                const qState = this.state.questionsMap[uniqueKey];
                const exData = exercises[exIndex];
                const qData = exData.questions.find(q => q.id === qId);

                if (qState.answered) return;

                qState.userAnswer = selectedOptId;
                qState.answered = true;

                // ID gap trong HTML: gap-{exIndex+1}-{qId}
                const gapEl = document.getElementById(`gap-${exIndex + 1}-${qId}`);
                const correctText = qData.options.find(o => o.id === qData.correct).text;

                if (selectedOptId === qData.correct) {
                    this.state.currentScore += qState.points;
                    gapEl.classList.add('correct');
                    gapEl.classList.remove('wrong');
                    gapEl.innerText = correctText;
                } else {
                    qState.points = 0;
                    gapEl.classList.add('wrong');
                    gapEl.innerText = correctText;
                }

                this.updateScoreDisplay();
                this.renderGamePanel(exIndex, qId);
                this.checkExerciseCompletion(exIndex);
            },

            // 7. KI·ªÇM TRA HO√ÄN TH√ÄNH B√ÄI
            checkExerciseCompletion: function(exIndex) {
                const exData = exercises[exIndex];
                const allAnswered = exData.questions.every(q => this.state.questionsMap[`${exIndex}-${q.id}`].answered);
                
                if (allAnswered) {
                    const btn = document.getElementById('next-ex-btn');
                    if (exIndex < exercises.length - 1) {
                        btn.style.display = 'block';
                        btn.innerText = "Chuy·ªÉn sang b√†i ti·∫øp theo ‚û°";
                    } else {
                        btn.style.display = 'block';
                        btn.innerText = "HO√ÄN TH√ÄNH T·∫§T C·∫¢";
                        btn.onclick = () => alert("B·∫°n ƒë√£ ho√†n th√†nh 3 b√†i Cloze Test! T·ªïng ƒëi·ªÉm: " + this.state.currentScore + "/" + this.state.maxScore);
                    }
                }
            },

            nextExercise: function() {
                this.initExercise(this.state.currentExIndex + 1);
            },

            updateScoreDisplay: function() {
                document.getElementById('current-score').innerText = this.state.currentScore;
                document.getElementById('max-score').innerText = this.state.maxScore;
            }
        };
    </script>
</body>
</html>