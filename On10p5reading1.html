<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cloze Test: Thinking Logic</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #1a73e8;
            --secondary-bg: #f0f2f5;
            --white: #ffffff;
            --text-main: #202124;
            --border: #dadce0;
            --orange: #f59e0b;
            --green: #1e8e3e;
            --red: #d93025;
            --header-height: 60px;
            --panel-height: 50vh; 
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--secondary-bg);
            color: var(--text-main);
            margin: 0;
            height: 100vh;
            display: flex;
            overflow: hidden; 
        }

        /* --- HEADER MOBILE --- */
        .mobile-header {
            display: none;
            position: fixed; top: 0; left: 0; right: 0;
            height: var(--header-height);
            background: var(--white);
            border-bottom: 1px solid var(--border);
            z-index: 100;
            align-items: center;
            padding: 0 15px;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .menu-btn { font-size: 1.4rem; color: #555; padding: 5px 10px; cursor: pointer; }
        .mobile-score { font-weight: 800; color: var(--primary); font-size: 1.1rem; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 300px;
            background: var(--white);
            border-right: 1px solid var(--border);
            display: flex; flex-direction: column;
            height: 100%; flex-shrink: 0;
            z-index: 200; 
            transition: transform 0.3s ease;
        }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .sidebar-header h3 { margin: 0; color: var(--primary); }
        .close-sidebar-btn { display: none; font-size: 1.2rem; cursor: pointer; }
        .stats-area { padding: 15px 20px; background: #f8f9fa; border-bottom: 1px solid var(--border); }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95rem; }
        .stat-value { font-weight: 800; color: var(--primary); }
        .question-grid-container { flex: 1; padding: 20px; overflow-y: auto; }
        .q-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .q-cell {
            aspect-ratio: 1; background: var(--white); border: 1px solid var(--border);
            border-radius: 8px; display: flex; justify-content: center; align-items: center;
            cursor: pointer; font-weight: 600; color: #666; transition: 0.2s;
        }
        .q-cell.active { background: var(--primary); color: white; border-color: var(--primary); }
        .q-cell.done { background: #e6f4ea; color: var(--green); border-color: var(--green); }
        .q-cell.wrong { background: #fce8e6; color: var(--red); border-color: var(--red); }
        .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 199; }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch; 
            display: flex; justify-content: center;
            position: relative;
            scroll-behavior: smooth; 
        }
        .content-wrapper { display: flex; width: 100%; max-width: 1200px; gap: 25px; }

        /* TEXT PANEL */
        .text-panel {
            flex: 2;
            background: var(--white); border-radius: 12px; padding: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            height: fit-content;
            line-height: 2.0; font-size: 1.15rem; color: #333;
        }
        
        .gap {
            display: inline-block; min-width: 40px; border-bottom: 2px solid #ccc;
            color: var(--primary); font-weight: 700; text-align: center;
            cursor: pointer; padding: 2px 6px; transition: 0.2s; border-radius: 4px;
        }
        .gap.active-gap { background-color: var(--primary); color: white; border-color: var(--primary); }
        .gap.correct { color: var(--green); border-bottom-color: var(--green); }
        .gap.wrong { color: var(--red); border-bottom-color: var(--red); } 
        .signal-word.highlighted { background-color: #fff176; font-weight: bold; color: black; border-radius: 3px; }

        /* QUESTION PANEL */
        .question-panel {
            flex: 1; min-width: 350px;
            position: sticky; top: 0; height: fit-content;
        }
        .q-card { background: var(--white); border-radius: 12px; padding: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        
        /* 1. OPTIONS (TOP) */
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .option-btn {
            padding: 12px 15px; border: 1px solid var(--border); background: white;
            border-radius: 8px; cursor: pointer; text-align: left; font-size: 1rem;
            display: flex; align-items: center; gap: 10px;
        }
        .option-label { font-weight: bold; color: #555; min-width: 25px; } 
        .option-text { flex: 1; } 
        .correct-select { background: #e6f4ea !important; border-color: var(--green) !important; color: var(--green) !important; font-weight: bold; }
        .wrong-select { background: #fce8e6 !important; border-color: var(--red) !important; color: var(--red) !important; }

        /* 2. HINTS (MIDDLE) */
        .hints-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; padding-top: 10px; border-top: 1px solid #eee; }
        .hint-item { border: 1px solid #eee; border-radius: 8px; overflow: hidden; background: #fafafa; }
        .hint-header { padding: 10px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-size: 0.9rem; font-weight: 600; }
        .hint-content { padding: 10px; background: white; border-top: 1px solid #eee; font-size: 0.95rem; display: none; line-height: 1.5; color: #444; }
        .hint-content.show { display: block; }

        /* 3. TRANSLATION (BOTTOM) */
        .trans-toggle-btn {
            width: 100%; margin-top: 5px; padding: 10px;
            background-color: #f8f9fa; border: 1px dashed var(--primary);
            color: var(--primary); border-radius: 8px; font-weight: 600;
            cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px;
            transition: 0.2s;
        }
        .trans-toggle-btn:hover { background-color: #e8f0fe; }
        .trans-box {
            margin-top: 10px; padding: 12px;
            background-color: #eef7ff; border-left: 4px solid var(--primary);
            border-radius: 4px; color: #333; font-style: italic; font-size: 0.95rem;
            line-height: 1.5; display: none; animation: fadeIn 0.3s ease;
        }
        .trans-box.show { display: block; }

        /* --- MOBILE RESPONSIVE --- */
        @media (max-width: 900px) {
            body { flex-direction: column; padding-top: var(--header-height); }
            .mobile-header { display: flex; }

            .sidebar {
                position: fixed; left: 0; top: 0; bottom: 0;
                width: 85%; max-width: 320px;
                transform: translateX(-100%);
                box-shadow: 2px 0 15px rgba(0,0,0,0.2);
            }
            .sidebar.active { transform: translateX(0); }
            .sidebar-overlay.active { display: block; }
            .close-sidebar-btn { display: block; }

            .main-content {
                display: block; width: 100%; padding: 0;
                height: calc(100vh - var(--header-height)); 
            }
            .content-wrapper { flex-direction: column; width: 100%; }
            
            .text-panel { 
                width: 100%; border-radius: 0; box-shadow: none; 
                padding: 20px; 
                padding-bottom: 80vh !important; 
            }

            .question-panel {
                position: fixed; bottom: 0; left: 0; right: 0; top: auto;
                width: 100%; z-index: 150;
                transform: translateY(120%);
                transition: transform 0.3s cubic-bezier(0.1, 0.7, 0.1, 1);
            }
            .question-panel.active { transform: translateY(0); }

            .q-card {
                border-radius: 20px 20px 0 0; 
                padding: 15px 20px 20px 20px;
                box-shadow: 0 -5px 25px rgba(0,0,0,0.15);
                height: var(--panel-height); 
                max-height: var(--panel-height);
                overflow-y: auto;
                border-top: 1px solid #ddd;
                position: relative;
            }

            .drag-handle {
                width: 40px; height: 5px; background: #e0e0e0;
                border-radius: 10px; margin: 0 auto 10px auto;
            }

            .mobile-collapse-btn {
                display: flex !important; justify-content: center; align-items: center;
                width: 28px; height: 28px; background: #f1f3f4; border-radius: 50%;
                position: absolute; right: 15px; top: 12px;
                cursor: pointer; color: #555;
            }

            #empty-state { display: none !important; }
        }

        .mobile-collapse-btn { display: none; }
    </style>
</head>
<body>

    <div class="mobile-header">
        <div class="menu-btn" onclick="app.toggleSidebar()">
            <i class="fas fa-bars"></i>
        </div>
        <div class="mobile-score">
            <span id="m-score">0</span> / <span id="m-max">0</span>
        </div>
        <div class="menu-btn" onclick="app.scrollToTop()">
            <i class="fas fa-arrow-up"></i>
        </div>
    </div>

    <div class="sidebar-overlay" onclick="app.toggleSidebar()"></div>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3><i class="fas fa-book-open"></i> Cloze Test</h3>
            <i class="fas fa-times close-sidebar-btn" onclick="app.toggleSidebar()"></i>
        </div>
        <div class="stats-area">
            <div class="stat-row">
                <span>Điểm số:</span>
                <span class="stat-value"><span id="current-score">0</span> / <span id="max-score">0</span></span>
            </div>
            <div style="font-size: 0.85rem; color: #666; margin-top:5px;">
                * 5đ/câu. Trừ 1đ/gợi ý.
            </div>
        </div>
        <div class="question-grid-container">
            <div style="font-weight:bold; margin-bottom:10px;">Câu hỏi</div>
            <div id="sidebar-grid" class="q-grid"></div>
        </div>
        <div style="padding: 20px; border-top:1px solid #eee;">
            <button onclick="app.nextExercise()" style="width:100%; padding:12px; background:var(--primary); color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">
                Bài tiếp theo <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </aside>

    <main class="main-content">
        <div class="content-wrapper">
            <div class="text-panel">
                <h2 id="ex-title" style="margin-top:0; color:var(--primary); font-size:1.3rem; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">Loading...</h2>
                <div id="ex-content"></div>
            </div>

            <div class="question-panel" id="question-panel">
                <div class="q-card" id="q-card-area">
                    <div class="drag-handle"></div>
                    <div class="mobile-collapse-btn" onclick="app.closeQuestionPanel()">
                        <i class="fas fa-chevron-down"></i>
                    </div>

                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding-right: 40px;">
                        <h3 style="margin:0; font-size:1.1rem;">Câu <span id="q-number">...</span></h3>
                        <span id="q-points-badge" style="background:var(--primary); color:white; padding:2px 8px; border-radius:12px; font-size:0.8rem; font-weight:bold;">5 Points</span>
                    </div>

                    <div class="options-grid" id="options-container"></div>

                    <div class="hints-list" id="hints-container"></div>

                    <div id="translation-section">
                        <button class="trans-toggle-btn" onclick="app.toggleTranslation()">
                            <i class="fas fa-language"></i> Dịch câu này
                        </button>
                        <div id="trans-content" class="trans-box"></div>
                    </div>

                </div>

                <div id="empty-state" style="text-align:center; color:#999; margin-top:50px;">
                    <i class="fas fa-mouse-pointer" style="font-size:2rem; margin-bottom:10px;"></i>
                    <p>Chọn ô trống để bắt đầu</p>
                </div>
            </div>
        </div>
    </main>

    <script>
       // --- DỮ LIỆU CẬP NHẬT: ĐỀ 13, 14, 15 ---
        const exercises = [
            {
                id: 13,
                title: "Đề 13: Memory Sharing Event",
                content: `
                    <h3 style="margin-top:0">Memory Sharing Event Announcement</h3>
                    <p>Dear Students, Our school will hold a Memory Sharing Event next week to help you look back on your childhood moments.</p>
                    <p>This is 
                    <span id="gap-1-17" class="gap" onclick="app.selectQuestion(1, 17)">(17) ______</span> 
                    special chance for everyone to talk about the people or events that they still remember clearly from the past. The event will be held in the library on Friday afternoon.</p>
                    <p>Students may bring old photos, small objects, or anything that 
                    <span id="gap-1-18" class="gap" onclick="app.selectQuestion(1, 18)">(18) ______</span> 
                    them of meaningful memories. Sharing these stories will not only be fun but also help you understand your classmates 
                    <span id="gap-1-19" class="gap" onclick="app.selectQuestion(1, 19)">(19) ______</span>.</p>
                    <p>We hope this meaningful activity will strengthen your friendships and make your school life more memorable.</p>
                `,
                questions: [
                    { 
                        id: 17, 
                        correct: "B", 
                        signalIds: [], 
                        sentence_translation: "Đây là ... cơ hội đặc biệt để mọi người nói về những người hoặc sự kiện mà họ vẫn nhớ rõ.", 
                        options: [
                            {id: "A", text: "an"}, 
                            {id: "B", text: "a"}, 
                            {id: "C", text: "the"}, 
                            {id: "D", text: "Ø"}
                        ], 
                        hints: [
                            "<strong>Enemy (Phân loại):</strong> Articles (Mạo từ).", 
                            "<strong>Signal (Dấu hiệu):</strong> 'special chance' (Singular Noun).", 
                            "<strong>Logic (Tư duy):</strong> Danh từ 'chance' ở đây được nhắc đến lần đầu (chung chung) hay đã xác định? Tính từ 'special' bắt đầu bằng phụ âm hay nguyên âm?", 
                            "<strong>Translation (Dịch đáp án):</strong><br>A. một (trước nguyên âm)<br>B. một (trước phụ âm)<br>C. cái/điều (xác định)<br>D. rỗng"
                        ] 
                    },
                    { 
                        id: 18, 
                        correct: "A", 
                        sentence_translation: "Học sinh có thể mang theo ảnh cũ... hoặc bất cứ thứ gì ... họ nhớ về những kỷ niệm ý nghĩa.", 
                        options: [
                            {id: "A", text: "reminds"}, 
                            {id: "B", text: "remember"}, 
                            {id: "C", text: "reminding"}, 
                            {id: "D", text: "reminder"}
                        ], 
                        hints: [
                            "<strong>Enemy (Phân loại):</strong> Vocabulary & Structure (Ngữ nghĩa & Cấu trúc).", 
                            "<strong>Signal (Dấu hiệu):</strong> 'that' (Subject) ... 'them' (Object) + 'of'.", 
                            "<strong>Logic (Tư duy):</strong> Cấu trúc nào đúng: 'Remind s.b OF sth' (Gợi cho ai nhớ về...) hay 'Remember s.b OF sth'?", 
                            "<strong>Translation (Dịch đáp án):</strong><br>A. gợi nhớ/nhắc nhở (V-s)<br>B. nhớ (V)<br>C. đang gợi nhớ (V-ing)<br>D. lời nhắc (N)"
                        ] 
                    },
                    { 
                        id: 19, 
                        correct: "B", 
                        sentence_translation: "Chia sẻ những câu chuyện này sẽ... giúp bạn hiểu bạn bè cùng lớp ...", 
                        options: [
                            {id: "A", text: "good"}, 
                            {id: "B", text: "better"}, 
                            {id: "C", text: "well"}, 
                            {id: "D", text: "many"}
                        ], 
                        hints: [
                            "<strong>Enemy (Phân loại):</strong> Adverb/Comparison (Trạng từ/So sánh).", 
                            "<strong>Signal (Dấu hiệu):</strong> 'understand' (Verb).", 
                            "<strong>Logic (Tư duy):</strong> Từ loại nào bổ nghĩa cho động từ 'understand'? Ngữ cảnh 'strengthen friendships' (củng cố tình bạn) ám chỉ sự hiểu biết ở mức độ 'tốt hơn' hay chỉ là 'tốt'?", 
                            "<strong>Translation (Dịch đáp án):</strong><br>A. tốt (Tính từ)<br>B. tốt hơn (So sánh hơn)<br>C. tốt (Trạng từ)<br>D. nhiều"
                        ] 
                    }
                ]
            },
            {
                id: 14,
                title: "Đề 14: Hai Phong Food Tourism",
                content: `
                    <h3 style="margin-top:0">Hai Phong Food Tourism: A Flavorful Destination</h3>
                    <p>Looking for the perfect location for food lovers? Hai Phong is the place! On our fixed itineraries, you will 
                    <span id="gap-2-17" class="gap" onclick="app.selectQuestion(2, 17)">(17) ______</span> 
                    for the best local dishes.</p>
                    <p>From bánh đa cua to nem cua bể, the city offers a 
                    <span id="gap-2-18" class="gap" onclick="app.selectQuestion(2, 18)">(18) ______</span> 
                    culinary experience. Wondering about the 
                    <span id="gap-2-19" class="gap" onclick="app.selectQuestion(2, 19)">(19) ______</span>? 
                    We ensure that the cost is affordable for everyone.</p>
                    <p>With expert guides and a smooth journey, you will discover the true taste of Hải Phòng. So, what are you waiting for? Book your tour today!</p>
                `,
                questions: [
                    { 
                        id: 17, 
                        correct: "A", 
                        sentence_translation: "Trong các lịch trình cố định của chúng tôi, bạn sẽ ... những món ăn địa phương ngon nhất.", 
                        options: [
                            {id: "A", text: "hunt"}, 
                            {id: "B", text: "look"}, 
                            {id: "C", text: "search"}, 
                            {id: "D", text: "seek"}
                        ], 
                        hints: [
                            "<strong>Enemy (Phân loại):</strong> Phrasal Verbs/Collocation (Từ vựng chủ đề du lịch).", 
                            "<strong>Signal (Dấu hiệu):</strong> 'for' + 'best local dishes'.", 
                            "<strong>Logic (Tư duy):</strong> Trong du lịch ẩm thực (Food Tour), người ta hay dùng thuật ngữ 'Food ...' để chỉ hành trình lùng sục, tìm kiếm món ngon?", 
                            "<strong>Translation (Dịch đáp án):</strong><br>A. săn lùng (thường dùng trong 'food hunt')<br>B. nhìn/tìm<br>C. tìm kiếm<br>D. tìm (thường không đi với for)"
                        ] 
                    },
                    { 
                        id: 18, 
                        correct: "D", 
                        sentence_translation: "Thành phố mang đến một trải nghiệm ẩm thực ...", 
                        options: [
                            {id: "A", text: "smooth"}, 
                            {id: "B", text: "delicious"}, 
                            {id: "C", text: "tasty"}, 
                            {id: "D", text: "flavorful"}
                        ], 
                        hints: [
                            "<strong>Enemy (Phân loại):</strong> Adjectives (Tính từ mô tả).", 
                            "<strong>Signal (Dấu hiệu):</strong> 'culinary experience' (trải nghiệm ẩm thực).", 
                            "<strong>Logic (Tư duy):</strong> 'Delicious' và 'Tasty' thường dùng để miêu tả trực tiếp món ăn. Tính từ nào phù hợp hơn để miêu tả một 'trải nghiệm' phong phú về hương vị?", 
                            "<strong>Translation (Dịch đáp án):</strong><br>A. trôi chảy/mượt mà<br>B. ngon (cho đồ ăn)<br>C. ngon (cho đồ ăn)<br>D. đậm đà/giàu hương vị (dùng cho cả trải nghiệm)"
                        ] 
                    },
                    { 
                        id: 19, 
                        correct: "A", 
                        sentence_translation: "Bạn đang băn khoăn về ... ư? Chúng tôi đảm bảo chi phí phải chăng cho mọi người.", 
                        options: [
                            {id: "A", text: "cost"}, 
                            {id: "B", text: "price"}, 
                            {id: "C", text: "fee"}, 
                            {id: "D", text: "charge"}
                        ], 
                        hints: [
                            "<strong>Enemy (Phân loại):</strong> Synonyms (Từ đồng nghĩa).", 
                            "<strong>Signal (Dấu hiệu):</strong> Câu sau: 'We ensure that the cost is affordable...'.", 
                            "<strong>Logic (Tư duy):</strong> Câu trả lời nằm ngay trong câu kế tiếp. Từ vựng nào được lặp lại để chỉ số tiền phải trả?", 
                            "<strong>Translation (Dịch đáp án):</strong><br>A. chi phí<br>B. giá cả<br>C. lệ phí<br>D. phí dịch vụ"
                        ] 
                    }
                ]
            },
            {
                id: 15,
                title: "Đề 15: Boost Your Health Easily",
                content: `
                    <h3 style="margin-top:0">Boost Your Health Easily!</h3>
                    <p>Feeling stressed? Here's a simple way to improve your body and mind. Follow our steps and you'll gain more 
                    <span id="gap-3-17" class="gap" onclick="app.selectQuestion(3, 17)">(17) ______</span> 
                    and stay active every day!</p>
                    <p>• Eat 
                    <span id="gap-3-18" class="gap" onclick="app.selectQuestion(3, 18)">(18) ______</span> 
                    of vegetables, nuts, and healthy food.</p>
                    <p>• Drink enough water and avoid sugary drinks.<br>
                    • Sleep well and relax after work.<br>
                    • Stay positive and take short breaks.</p>
                    <p>A healthy routine is 
                    <span id="gap-3-19" class="gap" onclick="app.selectQuestion(3, 19)">(19) ______</span> 
                    for everyone. Start now and enjoy a better life!</p>
                `,
                questions: [
                    { 
                        id: 17, 
                        correct: "A", 
                        sentence_translation: "Làm theo các bước của chúng tôi và bạn sẽ có thêm ... và duy trì sự năng động mỗi ngày!", 
                        options: [
                            {id: "A", text: "energy"}, 
                            {id: "B", text: "time"}, 
                            {id: "C", text: "question"}, 
                            {id: "D", text: "distraction"}
                        ], 
                        hints: [
                            "<strong>Enemy (Phân loại):</strong> Noun (Từ vựng Danh từ).", 
                            "<strong>Signal (Dấu hiệu):</strong> 'gain more...', 'stay active'.", 
                            "<strong>Logic (Tư duy):</strong> Để 'stay active' (duy trì hoạt động/năng động), cơ thể bạn cần nạp thêm cái gì?", 
                            "<strong>Translation (Dịch đáp án):</strong><br>A. năng lượng<br>B. thời gian<br>C. câu hỏi<br>D. sự xao nhãng"
                        ] 
                    },
                    { 
                        id: 18, 
                        correct: "C", 
                        sentence_translation: "Ăn ... rau củ, các loại hạt và thực phẩm lành mạnh.", 
                        options: [
                            {id: "A", text: "some"}, 
                            {id: "B", text: "few"}, 
                            {id: "C", text: "plenty"}, 
                            {id: "D", text: "any"}
                        ], 
                        hints: [
                            "<strong>Enemy (Phân loại):</strong> Quantifiers (Lượng từ).", 
                            "<strong>Signal (Dấu hiệu):</strong> Giới từ 'of' đứng ngay sau ô trống.", 
                            "<strong>Logic (Tư duy):</strong> Trong 4 đáp án, từ nào BẮT BUỘC phải đi với 'of' khi đứng trước danh từ? (Hint: 'Some' và 'Any' có cần 'of' không?)", 
                            "<strong>Translation (Dịch đáp án):</strong><br>A. một vài<br>B. rất ít<br>C. nhiều (plenty of)<br>D. bất kỳ"
                        ] 
                    },
                    { 
                        id: 19, 
                        correct: "C", 
                        sentence_translation: "Một thói quen lành mạnh là ... đối với mọi người.", 
                        options: [
                            {id: "A", text: "importance"}, 
                            {id: "B", text: "importantly"}, 
                            {id: "C", text: "important"}, 
                            {id: "D", text: "importances"}
                        ], 
                        hints: [
                            "<strong>Enemy (Phân loại):</strong> Word Form (Từ loại).", 
                            "<strong>Signal (Dấu hiệu):</strong> 'A healthy routine' (Subject) + 'is' (To be).", 
                            "<strong>Logic (Tư duy):</strong> Sau động từ 'to be' để miêu tả tính chất của chủ ngữ, ta cần Danh từ, Động từ hay Tính từ?", 
                            "<strong>Translation (Dịch đáp án):</strong><br>A. sự quan trọng (N)<br>B. một cách quan trọng (Adv)<br>C. quan trọng (Adj)<br>D. (sai chính tả)"
                        ] 
                    }
                ]
            }
        ];
        // --- APP LOGIC GIỮ NGUYÊN ---
        const app = {
            state: { exIdx: 0, currentScore: 0, maxScore: 0, qMap: {} },

            initExercise: function(index) {
                if(index >= exercises.length) { alert("Hoàn thành tất cả!"); return; }
                this.state.exIdx = index;
                const exData = exercises[index];

                document.getElementById('ex-title').innerText = exData.title;
                document.getElementById('ex-content').innerHTML = exData.content;
                this.scrollToTop();

                this.closeQuestionPanel();
                if(window.innerWidth > 900) {
                     document.getElementById('empty-state').style.display = 'block';
                     document.getElementById('q-card-area').style.display = 'none';
                }

                const grid = document.getElementById('sidebar-grid');
                grid.innerHTML = '';
                exData.questions.forEach(q => {
                    const key = `${index}-${q.id}`;
                    if (!this.state.qMap[key]) {
                        this.state.qMap[key] = { points: 5, hintsOpen: [false,false,false,false], answered: false, userChoice: null };
                        this.state.maxScore += 5;
                    }
                    const cell = document.createElement('div');
                    cell.className = 'q-cell';
                    cell.id = `cell-${q.id}`;
                    cell.innerText = q.id;
                    cell.onclick = () => {
                        this.selectQuestion(index+1, q.id);
                        if(window.innerWidth <= 900) this.toggleSidebar();
                    };
                    grid.appendChild(cell);
                });
                this.updateStats();
            },

            selectQuestion: function(exId, qId) {
                const realIndex = exId - 1;
                const exData = exercises[realIndex];
                const qData = exData.questions.find(q => q.id === qId);
                const key = `${realIndex}-${qId}`;
                const qState = this.state.qMap[key];

                document.querySelectorAll('.gap').forEach(e => e.classList.remove('active-gap'));
                const gap = document.getElementById(`gap-${exId}-${qId}`);
                if(gap) gap.classList.add('active-gap');

                document.querySelectorAll('.q-cell').forEach(e => e.classList.remove('active'));
                document.getElementById(`cell-${qId}`).classList.add('active');

                document.getElementById('q-number').innerText = qId;
                this.renderPointsBadge(qState);
                this.renderHints(realIndex, qId, qData, qState);
                this.renderOptions(realIndex, qId, qData, qState);

                // --- XỬ LÝ PHẦN DỊCH CÂU ---
                document.getElementById('trans-content').classList.remove('show');
                document.querySelector('.trans-toggle-btn').innerHTML = '<i class="fas fa-language"></i> Dịch câu này';
                const transText = qData.sentence_translation || "Chưa có bản dịch cho câu này.";
                document.getElementById('trans-content').innerHTML = transText;

                document.getElementById('empty-state').style.display = 'none';
                document.getElementById('q-card-area').style.display = 'block';
                document.getElementById('question-panel').classList.add('active');
                
                if(window.innerWidth <= 900 && gap) {
                    setTimeout(() => {
                        const container = document.querySelector('.main-content');
                        const gapRect = gap.getBoundingClientRect();
                        const containerRect = container.getBoundingClientRect();
                        const currentScroll = container.scrollTop;
                        const gapTopRelative = gapRect.top - containerRect.top; 
                        const targetScroll = currentScroll + gapTopRelative - 70;
                        container.scrollTo({ top: targetScroll, behavior: 'smooth' });
                    }, 300);
                }

                document.querySelectorAll('.signal-word').forEach(e => e.classList.remove('highlighted'));
                if (qState.hintsOpen[1] && qData.signalIds) {
                    qData.signalIds.forEach(id => {
                        const el = document.getElementById(id);
                        if(el) el.classList.add('highlighted');
                    });
                }
            },

            renderPointsBadge: function(qState) {
                const badge = document.getElementById('q-points-badge');
                badge.innerText = `${qState.points} pts`;
                badge.style.background = qState.answered ? (qState.points > 0 ? 'var(--green)' : 'var(--red)') : 'var(--primary)';
            },

            renderHints: function(exIndex, qId, qData, qState) {
                const container = document.getElementById('hints-container');
                container.innerHTML = '';
                qData.hints.forEach((hintText, i) => {
                    const isOpen = qState.hintsOpen[i];
                    const isLocked = i > 0 && !qState.hintsOpen[i-1] && !qState.answered;
                    
                    const div = document.createElement('div');
                    div.className = 'hint-item';
                    div.innerHTML = `
                        <div class="hint-header" onclick="app.openHint(${exIndex}, ${qId}, ${i})" style="opacity:${isLocked?0.5:1}">
                            <span><i class="fas ${isOpen?'fa-book-open':(isLocked?'fa-lock':'fa-lightbulb')}" style="color:${isOpen?'var(--primary)':'var(--orange)'};margin-right:8px;"></i>${isOpen?`Gợi ý ${i+1}`:`Gợi ý ${i+1}`}</span>
                            ${(!isOpen && !qState.answered) ? '<span style="font-size:0.75rem; color:red; bg:#fee; padding:2px;">-1đ</span>' : ''}
                        </div>
                        <div class="hint-content ${isOpen ? 'show' : ''}">${hintText}</div>
                    `;
                    container.appendChild(div);
                });
            },

            openHint: function(exIndex, qId, i) {
                const qState = this.state.qMap[`${exIndex}-${qId}`];
                if(qState.answered || qState.hintsOpen[i]) return;
                if(i > 0 && !qState.hintsOpen[i-1]) { alert("Vui lòng mở theo thứ tự!"); return; }
                
                if(qState.points > 0) qState.points--;
                qState.hintsOpen[i] = true;
                this.selectQuestion(exIndex+1, qId);
            },

            renderOptions: function(exIndex, qId, qData, qState) {
                const container = document.getElementById('options-container');
                container.innerHTML = '';
                qData.options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'option-btn';
                    btn.innerHTML = `<span class="option-label">${opt.id}.</span> <span class="option-text">${opt.text}</span>`;
                    
                    if(qState.answered) {
                        btn.disabled = true;
                        if(opt.id === qData.correct) btn.classList.add('correct-select');
                        if(opt.id === qState.userChoice && opt.id !== qData.correct) btn.classList.add('wrong-select');
                    } else {
                        btn.onclick = () => this.submitAnswer(exIndex, qId, opt.id);
                    }
                    container.appendChild(btn);
                });
            },

            toggleTranslation: function() {
                const box = document.getElementById('trans-content');
                const btn = document.querySelector('.trans-toggle-btn');
                
                if (box.classList.contains('show')) {
                    box.classList.remove('show');
                    btn.innerHTML = '<i class="fas fa-language"></i> Dịch câu này';
                    btn.style.backgroundColor = "#f8f9fa";
                    btn.style.color = "var(--primary)";
                } else {
                    box.classList.add('show');
                    btn.innerHTML = '<i class="fas fa-chevron-up"></i> Ẩn dịch';
                    btn.style.backgroundColor = "var(--primary)";
                    btn.style.color = "white";
                }
            },

            submitAnswer: function(exIndex, qId, choiceId) {
                const qState = this.state.qMap[`${exIndex}-${qId}`];
                const exData = exercises[exIndex];
                const qData = exData.questions.find(q => q.id === qId);

                qState.answered = true;
                qState.userChoice = choiceId;

                const gap = document.getElementById(`gap-${exIndex+1}-${qId}`);
                const cell = document.getElementById(`cell-${qId}`);

                if(choiceId === qData.correct) {
                    this.state.currentScore += qState.points;
                    gap.classList.add('correct');
                    gap.innerText = qData.options.find(o=>o.id===choiceId).text;
                    cell.classList.add('done');
                } else {
                    qState.points = 0;
                    gap.classList.add('wrong');
                    gap.innerText = qData.options.find(o=>o.id===qData.correct).text;
                    cell.classList.add('wrong');
                }
                this.updateStats();
                this.selectQuestion(exIndex+1, qId);
            },

            updateStats: function() {
                const s = this.state.currentScore;
                const m = this.state.maxScore;
                document.getElementById('current-score').innerText = s;
                document.getElementById('max-score').innerText = m;
                document.getElementById('m-score').innerText = s;
                document.getElementById('m-max').innerText = m;
            },

            toggleSidebar: function() {
                document.getElementById('sidebar').classList.toggle('active');
                document.querySelector('.sidebar-overlay').classList.toggle('active');
            },

            closeQuestionPanel: function() {
                document.getElementById('question-panel').classList.remove('active');
            },

            scrollToTop: function() {
                document.querySelector('.main-content').scrollTop = 0;
            },

            nextExercise: function() {
                this.initExercise(this.state.exIdx + 1);
            }
        };

        app.initExercise(0);
    </script>
</body>
</html>
