<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gamified Cloze Test System - New Data</title>
    <style>
        /* --- 1. SETUP BI·∫æN M√ÄU & C·∫§U H√åNH CHUNG --- */
        :root {
            --primary-color: #007bff;       /* Xanh d∆∞∆°ng */
            --success-color: #28a745;       /* Xanh l√° */
            --error-color: #dc3545;         /* ƒê·ªè */
            --highlight-color: #ffd700;     /* V√†ng Gold - D√πng cho Hint 2 */
            --bg-color: #f4f6f9;
            --text-color: #333;
            --white: #ffffff;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { margin: 0; padding: 20px; background-color: var(--bg-color); color: var(--text-color); }

        /* --- PASSWORD OVERLAY --- */
        #password-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white;
        }
        #password-input { padding: 10px; font-size: 1.2rem; border-radius: 5px; border: none; margin-bottom: 10px; }
        #password-btn { padding: 10px 20px; font-size: 1rem; background: var(--primary-color); color: white; border: none; border-radius: 5px; cursor: pointer; }
        
        /* --- 2. LAYOUT FLEXBOX (2 C·ªòT) --- */
        .container {
            display: flex;
            flex-wrap: wrap; 
            justify-content: center;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
            opacity: 0; transition: opacity 1s; 
        }
        .container.visible { opacity: 1; }

        /* --- C·ªòT TR√ÅI: ƒêO·∫†N VƒÇN --- */
        .text-panel {
            flex: 0 0 750px; max-width: 100%;
            background: var(--white); padding: 30px; border-radius: 8px;
            box-shadow: var(--shadow); font-size: 1.1rem; line-height: 1.8;
            height: fit-content;
        }

        /* --- C·ªòT PH·∫¢I: B·∫¢NG C√ÇU H·ªéI (STICKY) --- */
        .question-panel {
            flex: 0 0 450px; max-width: 100%;
            background: var(--white); padding: 20px; border-radius: 8px;
            box-shadow: var(--shadow);
            position: sticky; top: 20px;
            height: fit-content; max-height: 95vh; overflow-y: auto;
        }

        @media (max-width: 1250px) {
            .container { flex-direction: column; align-items: center; }
            .text-panel, .question-panel { flex: 1; width: 100%; max-width: 800px; }
            .question-panel { position: static; height: auto; }
        }

        /* --- ELEMENTS --- */
        .gap {
            display: inline-block; min-width: 50px;
            border-bottom: 2px solid var(--primary-color);
            color: var(--primary-color); font-weight: bold;
            text-align: center; cursor: pointer; padding: 0 5px;
            transition: all 0.3s;
        }
        .gap:hover, .gap.active { background-color: #eef7ff; border-radius: 4px; }
        .gap.correct { color: var(--success-color); border-bottom-color: var(--success-color); }
        .gap.wrong { color: var(--error-color); border-bottom-color: var(--error-color); text-decoration: line-through; }

        .signal-word { transition: background-color 0.5s ease; border-radius: 3px; padding: 0 2px; }
        .signal-word.highlighted { background-color: var(--highlight-color); font-weight: bold; color: black; }

        /* HEADER SCORE */
        .header-score {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #eee;
        }
        .score-display { font-size: 1.2rem; font-weight: bold; color: var(--primary-color); }

        /* OPTIONS GRID */
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .option-btn {
            padding: 12px; border: 1px solid #ddd; background: white;
            border-radius: 6px; cursor: pointer; font-size: 1rem;
            transition: all 0.2s; text-align: left;
        }
        .option-btn:hover:not(:disabled) { background-color: #f0f0f0; }
        
        /* TR·∫†NG TH√ÅI ƒê√ÅP √ÅN (CH·ªÆ TR·∫ÆNG) */
        .option-btn.correct-select { 
            background-color: var(--success-color) !important; 
            color: white !important; 
            border-color: var(--success-color) !important;
            font-weight: bold;
        }
        .option-btn.wrong-select { 
            background-color: var(--error-color) !important; 
            color: white !important; 
            border-color: var(--error-color) !important;
            font-weight: bold;
        }
        .option-btn.reveal-correct { 
            border: 2px solid var(--success-color); 
            color: var(--success-color); 
            font-weight: bold;
            position: relative;
        }
        .option-btn.reveal-correct::after {
            content: "‚úì"; position: absolute; right: 10px; font-weight: bold;
        }
        .option-btn:disabled { cursor: default; opacity: 0.9; }

        /* HINTS */
        .hints-container { display: flex; flex-direction: column; gap: 8px; }
        .hint-btn {
            width: 100%; text-align: left; padding: 10px;
            background: #f8f9fa; border: 1px solid #eee; border-radius: 5px;
            cursor: pointer; font-weight: 600; color: #555;
            display: flex; justify-content: space-between;
        }
        .hint-btn:hover:not(:disabled) { background: #e2e6ea; }
        .hint-btn:disabled { opacity: 0.5; cursor: not-allowed; background: #eee; }
        
        .hint-cost { font-size: 0.8em; color: var(--error-color); }
        .hint-content {
            padding: 10px; background: #fff; display: none;
            border: 1px solid #eee; border-top: none;
            font-size: 0.95rem; color: #444; line-height: 1.5;
        }
        .hint-content.show { display: block; animation: fadeIn 0.3s; }

        /* NEXT BUTTON */
        .nav-btn {
            margin-top: 20px; width: 100%; padding: 15px;
            background: var(--primary-color); color: white;
            border: none; border-radius: 5px; font-size: 1.1rem; font-weight: bold;
            cursor: pointer; display: none; 
        }
        .nav-btn:hover { background: #0056b3; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="password-overlay">
        <h2>üîí Y√™u c·∫ßu M·∫≠t kh·∫©u</h2>
        <p>Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ truy c·∫≠p 3 b√†i Cloze Test (G·ª£i √Ω: 1234)</p>
        <input type="password" id="password-input" placeholder="Nh·∫≠p m·∫≠t kh·∫©u...">
        <button id="password-btn" onclick="app.checkPassword()">V√†o l√†m b√†i</button>
        <p id="pass-error" style="color: #ff6b6b; display: none; margin-top: 10px;">M·∫≠t kh·∫©u sai!</p>
    </div>

    <div class="container" id="main-container">
        <div class="text-panel">
            <h2 id="ex-title">Loading...</h2>
            <div id="ex-content"></div>
        </div>

        <div class="question-panel">
            <div class="header-score">
                <span>Cloze Test Series</span>
                <span class="score-display">
                    Score: <span id="current-score">0</span> / <span id="max-score">0</span>
                </span>
            </div>

            <div id="game-area">
                <div style="text-align: center; color: #888; padding: 20px;">
                    H√£y ch·ªçn m·ªôt √¥ tr·ªëng b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu.
                </div>
            </div>

            <button id="next-ex-btn" class="nav-btn" onclick="app.nextExercise()">
                Chuy·ªÉn sang b√†i ti·∫øp theo ‚û°
            </button>
        </div>
    </div>

    <script>
        // --- DATA STORE (3 ƒê·ªÄ M·ªöI - ƒê√É C·∫¨P NH·∫¨T) ---
        const exercises = [
            {
                id: 1,
                title: "Exercise 1: Discover the iPhone 17!",
                content: `
                    <h3 style="margin-top:0">Discover the iPhone 17!</h3>
                    <p>
                        It 
                        <span id="gap-1-17" class="gap" onclick="app.selectQuestion(1, 17)">(20) ______</span> 
                        <span id="sig-1-17-1" class="signal-word">a bright screen</span>, 
                        a fast A17 chip, and a better camera. Enjoy longer battery life and 5G speed. Perfect for photos, games, and 
                        <span id="gap-1-18" class="gap" onclick="app.selectQuestion(1, 18)">(21) ______</span> 
                        <span id="sig-1-18-2" class="signal-word">in touch</span>. 
                        Get the iPhone 17 now and enjoy 
                        <span id="gap-1-19" class="gap" onclick="app.selectQuestion(1, 19)">(22) ______</span> 
                        <span id="sig-1-19-2" class="signal-word">latest technology</span>!
                    </p>
                `,
                questions: [
                    {
                        id: 17,
                        options: [{id: "A", text: "have"}, {id: "B", text: "has"}, {id: "C", text: "had"}, {id: "D", text: "having"}],
                        correct: "B",
                        signalElementIds: ["sig-1-17-1"], // "a bright screen" (Object), Subject "It" (implied context)
                        hints: [
                            "Hint 1 (Enemy): C√°c d·∫°ng c·ªßa ƒë·ªông t·ª´ 'Have'. B√†i t·∫≠p v·ªÅ NG·ªÆ PH√ÅP (Chia ƒë·ªông t·ª´).",
                            "Hint 2 (Signal): Ch·ªß ng·ªØ l√† 'It' (s·ªë √≠t) ·ªü ƒë·∫ßu c√¢u.",
                            "Hint 3 (Logic): Ch·ªß ng·ªØ s·ªë √≠t ·ªü th√¨ hi·ªán t·∫°i ƒë∆°n (qu·∫£ng c√°o t√≠nh nƒÉng)",
                            "Hint 4 (Trans):<br>A. c√≥ (s·ªë nhi·ªÅu)<br>B. c√≥ (s·ªë √≠t) + a bright screen<br>C. ƒë√£ c√≥<br>D. ƒëang c√≥"
                        ]
                    },
                    {
                        id: 18,
                        options: [{id: "A", text: "staying"}, {id: "B", text: "having"}, {id: "C", text: "getting"}, {id: "D", text: "making"}],
                        correct: "A",
                        signalElementIds: ["sig-1-18-2"], // "in touch"
                        hints: [
                            "Hint 1 (Enemy): 4 ƒê·ªông t·ª´ V-ing kh√°c nhau. B√†i t·∫≠p COLLOCATION (C·ª•m t·ª´ c·ªë ƒë·ªãnh).",
                            "Hint 2 (Signal): C·ª•m t·ª´ ph√≠a sau l√† '... in touch'.",
                            "Hint 3 (Logic): C·ª•m t·ª´ c·ªë ƒë·ªãnh ƒëi v·ªõi 'in touch' gi·ªØ li√™n l·∫°c",
                            "Hint 4 (Trans):<br>A. [gi·ªØ] + li√™n l·∫°c<br>B. [c√≥] + li√™n l·∫°c<br>C. [l·∫•y] + li√™n l·∫°c<br>D. [l√†m] + li√™n l·∫°c"
                        ]
                    },
                    {
                        id: 19,
                        options: [{id: "A", text: "a"}, {id: "B", text: "an"}, {id: "C", text: "the"}, {id: "D", text: "√ò (no article)"}],
                        correct: "C",
                        signalElementIds: ["sig-1-19-2"], // "latest technology"
                        hints: [
                            "Hint 1 (Enemy): C√°c M·∫°o t·ª´. B√†i t·∫≠p NG·ªÆ PH√ÅP.",
                            "Hint 2 (Signal): T√≠nh t·ª´ 'latest' (m·ªõi nh·∫•t) l√† d·∫°ng so s√°nh nh·∫•t.",
                            "Hint 3 (Logic): Tr∆∞·ªõc t√≠nh t·ª´ so s√°nh nh·∫•t (superlative) c·∫ßn d√πng m·∫°o t·ª´ g√¨.",
                            "Hint 4 (Trans):<br>A. m·ªôt + c√¥ng ngh·ªá m·ªõi nh·∫•t<br>B. m·ªôt + c√¥ng ngh·ªá m·ªõi nh·∫•t<br>C. [x√°c ƒë·ªãnh/duy nh·∫•t] + c√¥ng ngh·ªá m·ªõi nh·∫•t<br>D. r·ªóng"
                        ]
                    }
                ]
            },
            {
                id: 2,
                title: "Exercise 2: The Story of the Eiffel Tower",
                content: `
                    <h3 style="margin-top:0">ADVERTISEMENT: THE STORY OF THE EIFFEL TOWER</h3>
                    <p>
                        We're excited to tell you about the Eiffel Tower in Paris! A long time ago, in the late 1800s, Paris was getting ready for a big event. 
                        During this time, builders were creating 
                        <span id="gap-2-17" class="gap" onclick="app.selectQuestion(2, 17)">(17) ______</span> 
                        <span id="sig-2-17-2" class="signal-word">Eiffel Tower</span>, 
                        which would become a famous monument.
                    </p>
                    <p>
                        The building started in 1887, and the workers were busy working 
                        <span id="gap-2-18" class="gap" onclick="app.selectQuestion(2, 18)">(18) ______</span> 
                        <span id="sig-2-18-2" class="signal-word">the metal parts</span> 
                        and shaping the tower. While they 
                        <span id="gap-2-19" class="gap" onclick="app.selectQuestion(2, 19)">(19) ______</span> 
                        <span id="sig-2-19-2" class="signal-word">on the tower</span>, 
                        many people in Paris were waiting for it to be finish.By 1889, the Eiffel Tower was done and it became a symbol of Paris. Visitors from all over came to see it and were amazed by its design. Today, it remains one of the most well-known landmarks in the world!
                    </p>
                `,
                questions: [
                    {
                        id: 17,
                        options: [{id: "A", text: "the"}, {id: "B", text: "a"}, {id: "C", text: "an"}, {id: "D", text: "X"}],
                        correct: "A",
                        signalElementIds: ["sig-2-17-2"], // "Eiffel Tower"
                        hints: [
                            "Hint 1 (Enemy): M·∫°o t·ª´. B√†i t·∫≠p NG·ªÆ PH√ÅP.",
                            "Hint 2 (Signal): T√™n ri√™ng 'Eiffel Tower' (C√¥ng tr√¨nh ki·∫øn tr√∫c).",
                            "Hint 3 (Logic): V·ªõi t√™n c√°c c√¥ng tr√¨nh, th√°p, t∆∞·ª£ng ƒë√†i, ta th∆∞·ªùng d√πng g√¨.",
                            "Hint 4 (Trans):<br>A. [x√°c ƒë·ªãnh] + th√°p Eiffel<br>B. m·ªôt + th√°p Eiffel<br>C. m·ªôt + th√°p Eiffel<br>D. r·ªóng"
                        ]
                    },
                    {
                        id: 18,
                        options: [{id: "A", text: "at"}, {id: "B", text: "on"}, {id: "C", text: "with"}, {id: "D", text: "in"}],
                        correct: "B",
                        signalElementIds: ["sig-2-18-2"], // "the metal parts"
                        hints: [
                            "Hint 1 (Enemy): Gi·ªõi t·ª´. B√†i t·∫≠p C·∫§U TR√öC/PHRASAL VERB.",
                            "Hint 2 (Signal): ƒê·ªông t·ª´ 'working' + t√∫c t·ª´ 'metal parts' (b·ªô ph·∫≠n kim lo·∫°i).",
                            "Hint 3 (Logic): C·ª•m 'Work on something' x·ª≠ l√Ω, ch·∫ø t·∫°o ho·∫∑c s·ª≠a ch·ªØa. 'Work with' + c√¥ng c·ª• ho·∫∑c ng∆∞·ªùi.",
                            "Hint 4 (Trans):<br>A. l√†m vi·ªác t·∫°i<br>B. l√†m vi·ªác tr√™n/x·ª≠ l√Ω (c√°c b·ªô ph·∫≠n kim lo·∫°i)<br>C. l√†m vi·ªác v·ªõi<br>D. l√†m vi·ªác trong"
                        ]
                    },
                    {
                        id: 19,
                        options: [{id: "A", text: "built"}, {id: "B", text: "were building"}, {id: "C", text: "builds"}, {id: "D", text: "are building"}],
                        correct: "B",
                        signalElementIds: ["sig-2-19-2"], // "While" at start of sentence (logic)
                        hints: [
                            "Hint 1 (Enemy): C√°c th√¨ c·ªßa ƒë·ªông t·ª´. B√†i t·∫≠p NG·ªÆ PH√ÅP.",
                            "Hint 2 (Signal): Li√™n t·ª´ 'While' (Trong khi) ·ªü qu√° kh·ª© (1887).",
                            "Hint 3 (Logic): 'While' + h√†nh ƒë·ªông d√†i (Was/Were + V-ing).",
                            "Hint 4 (Trans):<br>A. ƒë√£ x√¢y (Qk ƒë∆°n)<br>B. ƒëang x√¢y (Qk ti·∫øp di·ªÖn)<br>C. x√¢y (Hi·ªán t·∫°i ƒë∆°n)<br>D. ƒëang x√¢y (Hi·ªán t·∫°i ti·∫øp di·ªÖn)"
                        ]
                    }
                ]
            },
            {
                id: 3,
                title: "Exercise 3: Career Choices Announcement",
                content: `
                    <h3 style="margin-top:0">Career Choices Announcement</h3>
                    <p>
                        Choosing the right career is very important for your future. A good career gives you 
                        <span id="gap-3-17" class="gap" onclick="app.selectQuestion(3, 17)">(17) ______</span> 
                        <span id="sig-3-17-2" class="signal-word">opportunities</span> 
                        to grow and learn. It also helps you feel successful.
                    </p>
                    <p>
                        When selecting 
                        <span id="gap-3-18" class="gap" onclick="app.selectQuestion(3, 18)">(18) ______</span> 
                        <span id="sig-3-18-2" class="signal-word">job</span>, 
                        think about what you enjoy and what skills you have. Some people like jobs where they can work with others , while some prefer working alone. There are many careers to choose from, such as doctor, teacher, or engineer. Each job is different and requires special skills. 
                    </p>
                    <p>
                        You should choose a career 
                        <span id="gap-3-19" class="gap" onclick="app.selectQuestion(3, 19)">(19) ______</span> 
                        <span id="sig-3-19-2" class="signal-word">fits</span> 
                        your interests and goals. Sometimes, people change careers because they want to try something new or develop new skills.
                    </p>
                `,
                questions: [
                    {
                        id: 17,
                        options: [{id: "A", text: "many"}, {id: "B", text: "few"}, {id: "C", text: "little"}, {id: "D", text: "much"}],
                        correct: "A",
                        signalElementIds: ["sig-3-17-2"], // "opportunities"
                        hints: [
                            "Hint 1 (Enemy): L∆∞·ª£ng t·ª´ (Quantifiers). B√†i t·∫≠p NG·ªÆ PH√ÅP.",
                            "Hint 2 (Signal): Danh t·ª´ 'opportunities' (t·∫≠n c√πng l√† 's') ƒë·ª©ng sau.",
                            "Hint 3 (Logic): L∆∞·ª£ng t·ª´ n√†o ƒëi v·ªõi Ns, mang nghƒ©a t√≠ch c·ª±c.",
                            "Hint 4 (Trans):<br>A. nhi·ªÅu + c∆° h·ªôi<br>B. r·∫•t √≠t + c∆° h·ªôi<br>C. √≠t + c∆° h·ªôi<br>D. nhi·ªÅu + c∆° h·ªôi (d√πng cho kh√¥ng ƒë·∫øm ƒë∆∞·ª£c)"
                        ]
                    },
                    {
                        id: 18,
                        options: [{id: "A", text: "a"}, {id: "B", text: "an"}, {id: "C", text: "the"}, {id: "D", text: "√ò (no article)"}],
                        correct: "A",
                        signalElementIds: ["sig-3-18-2"], // "job"
                        hints: [
                            "Hint 1 (Enemy): M·∫°o t·ª´. B√†i t·∫≠p NG·ªÆ PH√ÅP.",
                            "Hint 2 (Signal): Danh t·ª´ 'job' (s·ªë √≠t, ƒë·∫øm ƒë∆∞·ª£c, b·∫Øt ƒë·∫ßu b·∫±ng ph·ª• √¢m 'j').",
                            "Hint 3 (Logic): Lo·∫°i ƒë√°p √°n n√†o, Ngh·ªÅ nghi·ªáp d√πng g√¨? ",
                            "Hint 4 (Trans):<br>A. m·ªôt + c√¥ng vi·ªác<br>B. m·ªôt + c√¥ng vi·ªác (sai √¢m)<br>C. c√¥ng vi·ªác ·∫•y (x√°c ƒë·ªãnh)<br>D. r·ªóng"
                        ]
                    },
                    {
                        id: 19,
                        options: [{id: "A", text: "who"}, {id: "B", text: "that"}, {id: "C", text: "what"}, {id: "D", text: "where"}],
                        correct: "B",
                        signalElementIds: ["sig-3-19-2"], // "fits" (Verb), antecedent "career" (Thing)
                        hints: [
                            "Hint 1 (Enemy): ƒê·∫°i t·ª´ quan h·ªá. B√†i t·∫≠p C·∫§U TR√öC C√ÇU.",
                            "Hint 2 (Signal): Ph√≠a sau l√† 'fits', ph√≠a tr∆∞·ªõc l√† 'career'.",
                            "Hint 3 (Logic): Theo sau l√† ƒë·ªông t·ª´, tr∆∞·ªõc l√† Danh t·ª´ ch·ªâ v·∫≠t. Lo·∫°i ƒë√°p √°n n√†o.",
                            "Hint 4 (Trans):<br>A. ng∆∞·ªùi m√† + ph√π h·ª£p<br>B. c√°i m√† + ph√π h·ª£p<br>C. c√°i g√¨ + ph√π h·ª£p<br>D. n∆°i m√† + ph√π h·ª£p"
                        ]
                    }
                ]
            }
        ];

        // --- CONTROLLER (LOGIC APP) ---
        const app = {
            state: {
                currentExIndex: 0,
                currentScore: 0,
                maxScore: 0, 
                questionsMap: {}, 
            },

            // 1. PASSWORD CHECK
            checkPassword: function() {
                const pass = document.getElementById('password-input').value;
                if (pass === "1234") {
                    document.getElementById('password-overlay').style.display = 'none';
                    document.getElementById('main-container').classList.add('visible');
                    this.initExercise(0);
                } else {
                    document.getElementById('pass-error').style.display = 'block';
                }
            },

            // 2. KH·ªûI T·∫†O B√ÄI T·∫¨P
            initExercise: function(index) {
                if (index >= exercises.length) {
                    alert("Ch√∫c m·ª´ng! B·∫°n ƒë√£ ho√†n th√†nh t·∫•t c·∫£ b√†i t·∫≠p.");
                    return;
                }

                this.state.currentExIndex = index;
                const exData = exercises[index];

                // C·∫≠p nh·∫≠t giao di·ªán Text
                document.getElementById('ex-title').innerText = exData.title;
                document.getElementById('ex-content').innerHTML = exData.content;
                document.getElementById('game-area').innerHTML = '<div style="text-align:center; color:#888; padding:20px;">Ch·ªçn m·ªôt √¥ tr·ªëng (v√≠ d·ª•: 17, 18) trong vƒÉn b·∫£n ƒë·ªÉ b·∫Øt ƒë·∫ßu.</div>';
                
                // N√∫t Next
                const btn = document.getElementById('next-ex-btn');
                btn.style.display = 'none';

                // Reset map c√¢u h·ªèi cho b√†i m·ªõi
                exData.questions.forEach(q => {
                    const uniqueKey = `${index}-${q.id}`;
                    // Reset n·∫øu ch∆∞a l√†m, ho·∫∑c gi·ªØ nguy√™n state n·∫øu mu·ªën l∆∞u progress
                    // ·ªû ƒë√¢y ta reset points nh∆∞ng c·ªông d·ªìn maxScore
                    if(!this.state.questionsMap[uniqueKey]) {
                        this.state.questionsMap[uniqueKey] = {
                            answered: false,
                            points: 5,
                            hintsOpened: [false, false, false, false],
                            userAnswer: null
                        };
                        this.state.maxScore += 5;
                    }
                });
                
                this.updateScoreDisplay();
            },

            // 3. CH·ªåN C√ÇU H·ªéI
            selectQuestion: function(exId, qId) {
                // exId ·ªü ƒë√¢y l√† ID trong HTML (1,2,3) -> c·∫ßn chuy·ªÉn th√†nh index (0,1,2)
                const realExIndex = exId - 1; 
                
                // Highlight gap
                document.querySelectorAll('.gap').forEach(el => el.classList.remove('active'));
                const activeGap = document.getElementById(`gap-${exId}-${qId}`);
                if(activeGap) activeGap.classList.add('active');

                this.renderGamePanel(realExIndex, qId);
            },

            // 4. RENDER B·∫¢NG C√ÇU H·ªéI
            renderGamePanel: function(exIndex, qId) {
                const exData = exercises[exIndex];
                const qData = exData.questions.find(q => q.id === qId);
                const uniqueKey = `${exIndex}-${qId}`;
                const qState = this.state.questionsMap[uniqueKey];
                const panel = document.getElementById('game-area');

                if (!qData) return;

                // X·ª≠ l√Ω logic Hint 2 (Highlight l·∫°i n·∫øu ƒë√£ m·ªü)
                document.querySelectorAll('.signal-word').forEach(el => el.classList.remove('highlighted'));
                if (qState.hintsOpened[1]) { 
                    qData.signalElementIds.forEach(id => {
                         const el = document.getElementById(id);
                         if(el) el.classList.add('highlighted');
                    });
                }

                let html = `
                    <div class="current-q-info">
                        <div style="font-weight:bold; margin-bottom:5px;">Question ${qId}</div>
                        <div style="font-size:0.9rem; color:#666;">
                            ƒêi·ªÉm: <b style="color:${qState.answered ? (qState.points > 0 ? 'var(--success-color)' : 'var(--error-color)') : 'var(--primary-color)'}">
                                ${qState.answered ? (qState.points > 0 ? '+' + qState.points : '0') : qState.points}
                            </b>
                        </div>
                    </div>

                    <div class="options-grid">
                        ${qData.options.map(opt => {
                            let btnClass = 'option-btn';
                            let disabled = '';
                            if (qState.answered) {
                                disabled = 'disabled';
                                if (opt.id === qData.correct) btnClass += ' reveal-correct';
                                if (opt.id === qState.userAnswer) {
                                    btnClass += (opt.id === qData.correct) ? ' correct-select' : ' wrong-select';
                                }
                            }
                            return `<button class="${btnClass}" ${disabled} onclick="app.submitAnswer(${exIndex}, ${qId}, '${opt.id}')">${opt.id}. ${opt.text}</button>`;
                        }).join('')}
                    </div>

                    <div class="hints-container">
                        <div style="font-size:0.9rem; font-weight:bold; margin-bottom:5px; color:#555;">G·ª£i √Ω (M·ªü theo th·ª© t·ª±):</div>
                        ${qData.hints.map((hintText, index) => {
                            const isOpened = qState.hintsOpened[index];
                            const isLocked = index > 0 && !qState.hintsOpened[index - 1];
                            const disabledAttr = (qState.answered || isLocked) && !isOpened ? 'disabled' : '';

                            return `
                                <div class="hint-item">
                                    <button class="hint-btn" ${disabledAttr} onclick="app.openHint(${exIndex}, ${qId}, ${index})">
                                        <span>${isOpened ? 'üìñ Hint ' + (index+1) : (isLocked ? 'üîí Locked' : 'üîê M·ªü Hint ' + (index+1))}</span>
                                        <span class="hint-cost">${isOpened || qState.answered ? '' : '-1 Point'}</span>
                                    </button>
                                    <div class="hint-content ${isOpened ? 'show' : ''}">${hintText}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                panel.innerHTML = html;
            },

            // 5. X·ª¨ L√ù HINT
            openHint: function(exIndex, qId, hintIndex) {
                const uniqueKey = `${exIndex}-${qId}`;
                const qState = this.state.questionsMap[uniqueKey];
                
                if (hintIndex > 0 && !qState.hintsOpened[hintIndex - 1]) {
                    alert("B·∫°n ph·∫£i m·ªü g·ª£i √Ω tr∆∞·ªõc ƒë√≥ tr∆∞·ªõc!");
                    return;
                }
                
                if (!qState.answered && !qState.hintsOpened[hintIndex]) {
                    if (qState.points > 0) qState.points -= 1;
                    qState.hintsOpened[hintIndex] = true;
                    this.renderGamePanel(exIndex, qId);
                }
            },

            // 6. X·ª¨ L√ù TR·∫¢ L·ªúI
            submitAnswer: function(exIndex, qId, selectedOptId) {
                const uniqueKey = `${exIndex}-${qId}`;
                const qState = this.state.questionsMap[uniqueKey];
                const exData = exercises[exIndex];
                const qData = exData.questions.find(q => q.id === qId);

                if (qState.answered) return;

                qState.userAnswer = selectedOptId;
                qState.answered = true;

                // ID gap trong HTML: gap-{exIndex+1}-{qId}
                const gapEl = document.getElementById(`gap-${exIndex + 1}-${qId}`);
                const correctText = qData.options.find(o => o.id === qData.correct).text;

                if (selectedOptId === qData.correct) {
                    this.state.currentScore += qState.points;
                    gapEl.classList.add('correct');
                    gapEl.classList.remove('wrong');
                    gapEl.innerText = correctText;
                } else {
                    qState.points = 0;
                    gapEl.classList.add('wrong');
                    gapEl.innerText = correctText;
                }

                this.updateScoreDisplay();
                this.renderGamePanel(exIndex, qId);
                this.checkExerciseCompletion(exIndex);
            },

            // 7. KI·ªÇM TRA HO√ÄN TH√ÄNH B√ÄI
            checkExerciseCompletion: function(exIndex) {
                const exData = exercises[exIndex];
                const allAnswered = exData.questions.every(q => {
                    const key = `${exIndex}-${q.id}`;
                    return this.state.questionsMap[key] && this.state.questionsMap[key].answered;
                });
                
                if (allAnswered) {
                    const btn = document.getElementById('next-ex-btn');
                    if (exIndex < exercises.length - 1) {
                        btn.style.display = 'block';
                        btn.innerText = "Chuy·ªÉn sang b√†i ti·∫øp theo ‚û°";
                    } else {
                        btn.style.display = 'block';
                        btn.innerText = "HO√ÄN TH√ÄNH T·∫§T C·∫¢";
                        btn.onclick = () => alert("B·∫°n ƒë√£ ho√†n th√†nh 3 b√†i Cloze Test! T·ªïng ƒëi·ªÉm: " + this.state.currentScore + "/" + this.state.maxScore);
                    }
                }
            },

            nextExercise: function() {
                this.initExercise(this.state.currentExIndex + 1);
            },

            updateScoreDisplay: function() {
                document.getElementById('current-score').innerText = this.state.currentScore;
                document.getElementById('max-score').innerText = this.state.maxScore;
            }
        };
    </script>
</body>
</html>
