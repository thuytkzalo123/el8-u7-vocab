<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gamified Cloze Test - New Data Set</title>
    <style>
        /* --- 1. SETUP BI·∫æN M√ÄU & C·∫§U H√åNH CHUNG --- */
        :root {
            --primary-color: #007bff;       /* Xanh d∆∞∆°ng */
            --success-color: #28a745;       /* Xanh l√° */
            --error-color: #dc3545;         /* ƒê·ªè */
            --highlight-color: #ffd700;     /* V√†ng Gold - D√πng cho Hint 2 */
            --bg-color: #f4f6f9;
            --text-color: #333;
            --white: #ffffff;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { margin: 0; padding: 20px; background-color: var(--bg-color); color: var(--text-color); }

        /* --- PASSWORD OVERLAY --- */
        #password-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white;
        }
        #password-input { padding: 10px; font-size: 1.2rem; border-radius: 5px; border: none; margin-bottom: 10px; }
        #password-btn { padding: 10px 20px; font-size: 1rem; background: var(--primary-color); color: white; border: none; border-radius: 5px; cursor: pointer; }
        #pass-error { color: #ff6b6b; display: none; margin-top: 10px; font-weight: bold; }

        /* --- 2. LAYOUT FLEXBOX (2 C·ªòT) --- */
        .container {
            display: flex;
            flex-wrap: wrap; 
            justify-content: center;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
            opacity: 0; transition: opacity 1s; 
        }
        .container.visible { opacity: 1; }

        /* --- C·ªòT TR√ÅI: ƒêO·∫†N VƒÇN --- */
        .text-panel {
            flex: 0 0 750px; max-width: 100%;
            background: var(--white); padding: 30px; border-radius: 8px;
            box-shadow: var(--shadow); font-size: 1.1rem; line-height: 1.8;
            height: fit-content;
        }

        /* --- C·ªòT PH·∫¢I: B·∫¢NG C√ÇU H·ªéI (STICKY) --- */
        .question-panel {
            flex: 0 0 450px; max-width: 100%;
            background: var(--white); padding: 20px; border-radius: 8px;
            box-shadow: var(--shadow);
            position: sticky; top: 20px;
            height: fit-content; max-height: 95vh; overflow-y: auto;
        }

        @media (max-width: 1250px) {
            .container { flex-direction: column; align-items: center; }
            .text-panel, .question-panel { flex: 1; width: 100%; max-width: 800px; }
            .question-panel { position: static; height: auto; }
        }

        /* --- ELEMENTS --- */
        .gap {
            display: inline-block; min-width: 50px;
            border-bottom: 2px solid var(--primary-color);
            color: var(--primary-color); font-weight: bold;
            text-align: center; cursor: pointer; padding: 0 5px;
            transition: all 0.3s;
        }
        .gap:hover, .gap.active { background-color: #eef7ff; border-radius: 4px; }
        .gap.correct { color: var(--success-color); border-bottom-color: var(--success-color); }
        .gap.wrong { color: var(--error-color); border-bottom-color: var(--error-color); text-decoration: line-through; }

        .signal-word { transition: background-color 0.5s ease; border-radius: 3px; padding: 0 2px; }
        .signal-word.highlighted { background-color: var(--highlight-color); font-weight: bold; color: black; }

        /* HEADER SCORE */
        .header-score {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #eee;
        }
        .score-display { font-size: 1.2rem; font-weight: bold; color: var(--primary-color); }

        /* OPTIONS GRID */
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .option-btn {
            padding: 12px; border: 1px solid #ddd; background: white;
            border-radius: 6px; cursor: pointer; font-size: 1rem;
            transition: all 0.2s; text-align: left;
        }
        .option-btn:hover:not(:disabled) { background-color: #f0f0f0; }
        
        /* TR·∫†NG TH√ÅI ƒê√ÅP √ÅN (CH·ªÆ TR·∫ÆNG, ƒê·∫¨M) */
        .option-btn.correct-select { 
            background-color: var(--success-color) !important; 
            color: white !important; 
            border-color: var(--success-color) !important;
            font-weight: bold;
        }
        .option-btn.wrong-select { 
            background-color: var(--error-color) !important; 
            color: white !important; 
            border-color: var(--error-color) !important;
            font-weight: bold;
        }
        .option-btn.reveal-correct { 
            border: 2px solid var(--success-color); 
            color: var(--success-color); 
            font-weight: bold;
            position: relative;
        }
        .option-btn.reveal-correct::after {
            content: "‚úì"; position: absolute; right: 10px; font-weight: bold;
        }
        .option-btn:disabled { cursor: default; opacity: 0.9; }

        /* HINTS */
        .hints-container { display: flex; flex-direction: column; gap: 8px; }
        .hint-btn {
            width: 100%; text-align: left; padding: 10px;
            background: #f8f9fa; border: 1px solid #eee; border-radius: 5px;
            cursor: pointer; font-weight: 600; color: #555;
            display: flex; justify-content: space-between;
        }
        .hint-btn:hover:not(:disabled) { background: #e2e6ea; }
        .hint-btn:disabled { opacity: 0.5; cursor: not-allowed; background: #eee; }
        
        .hint-cost { font-size: 0.8em; color: var(--error-color); }
        .hint-content {
            padding: 10px; background: #fff; display: none;
            border: 1px solid #eee; border-top: none;
            font-size: 0.95rem; color: #444; line-height: 1.5;
        }
        .hint-content.show { display: block; animation: fadeIn 0.3s; }

        /* NEXT BUTTON */
        .nav-btn {
            margin-top: 20px; width: 100%; padding: 15px;
            background: var(--primary-color); color: white;
            border: none; border-radius: 5px; font-size: 1.1rem; font-weight: bold;
            cursor: pointer; display: none; 
        }
        .nav-btn:hover { background: #0056b3; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="password-overlay">
        <h2>üîí Y√™u c·∫ßu M·∫≠t kh·∫©u</h2>
        <p>Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ truy c·∫≠p (G·ª£i √Ω: 1234)</p>
        <input type="password" id="password-input" placeholder="Nh·∫≠p m·∫≠t kh·∫©u...">
        <button id="password-btn" onclick="app.checkPassword()">V√†o l√†m b√†i</button>
        <p id="pass-error">M·∫≠t kh·∫©u sai!</p>
    </div>

    <div class="container" id="main-container">
        <div class="text-panel">
            <h2 id="ex-title">Loading...</h2>
            <div id="ex-content"></div>
        </div>

        <div class="question-panel">
            <div class="header-score">
                <span>Cloze Test Series</span>
                <span class="score-display">
                    Score: <span id="current-score">0</span> / <span id="max-score">0</span>
                </span>
            </div>

            <div id="game-area">
                <div style="text-align: center; color: #888; padding: 20px;">
                    H√£y ch·ªçn m·ªôt √¥ tr·ªëng b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu.
                </div>
            </div>

            <button id="next-ex-btn" class="nav-btn" onclick="app.nextExercise()">
                Chuy·ªÉn sang b√†i ti·∫øp theo ‚û°
            </button>
        </div>
    </div>

    <script>
        // --- DATA STORE (3 ƒê·ªÄ M·ªöI - ƒê√É C·∫¨P NH·∫¨T) ---
        const exercises = [
            {
                id: 1,
                title: "Exercise 1: HEALTHY LIFESTYLE CAMPAIGN",
                content: `
                    <h3 style="margin-top:0">HEALTHY LIFESTYLE CAMPAIGN</h3>
                    <p>
                        Join us for a Healthy Lifestyle Campaign at our school. Throughout the month, we'll be organizing various activities and initiatives to promote 
                        <span id="gap-1-20" class="gap" onclick="app.selectQuestion(1, 20)">(20) ______</span> 
                        <span id="sig-1-20-2" class="signal-word">and mental well-being</span>.
                    </p>
                    <p>
                        On the campaign, you can engage 
                        <span id="gap-1-21" class="gap" onclick="app.selectQuestion(1, 21)">(21) ______</span> 
                        <span id="sig-1-21-2" class="signal-word">interactive workshops</span>, 
                        fitness classes, and awareness sessions that focus on the importance of maintaining a healthy lifestyle. These activities aim to enhance 
                        <span id="gap-1-22" class="gap" onclick="app.selectQuestion(1, 22)">(22) ______</span> 
                        <span id="sig-1-22-2" class="signal-word">about the benefits</span> 
                        of exercise, proper nutrition, and stress management.
                    </p>
                    <p>
                        <span id="gap-1-23" class="gap" onclick="app.selectQuestion(1, 23)">(23) ______</span> 
                        <span id="sig-1-23-2" class="signal-word">you want to</span> 
                        get more involved, keep in touch with our campaign coordinator who will provide more information on upcoming events and guide you on how to adopt 
                        <span id="gap-1-24" class="gap" onclick="app.selectQuestion(1, 24)">(24) ______</span>.
                        <span id="sig-1-24-1" class="signal-word" style="display:none">adopt</span>
                    </p>
                `,
                questions: [
                    {
                        id: 20,
                        options: [{id: "A", text: "physic"}, {id: "B", text: "physically"}, {id: "C", text: "physics"}, {id: "D", text: "physical"}],
                        correct: "D",
                        signalElementIds: ["sig-1-20-2"], // "and mental well-being"
                        hints: [
                            "Hint 1 (Enemy): Gia ƒë√¨nh t·ª´ (Word Form). ƒê√¢y l√† b√†i t·∫≠p T·ª™ LO·∫†I.",
                            "Hint 2 (Signal): Li√™n t·ª´ 'and' v√† c·ª•m danh t·ª´ 'mental well-being' (s·ª©c kh·ªèe tinh th·∫ßn).",
                            "Hint 3 (Logic): H√£y xem x√©t quy t·∫Øc song h√†nh v·ªõi 'and'. T·ª´ 'mental' l√† lo·∫°i t·ª´ g√¨? V·ªã tr√≠ n√†y c·∫ßn lo·∫°i t·ª´ t∆∞∆°ng ·ª©ng ƒë·ªÉ b·ªï nghƒ©a cho 'well-being'.",
                            "Hint 4 (Trans):<br>A. thu·ªëc/y h·ªçc (Noun)<br>B. v·ªÅ m·∫∑t th·ªÉ ch·∫•t (Adv)<br>C. v·∫≠t l√Ω h·ªçc (Noun)<br>D. thu·ªôc v·ªÅ th·ªÉ ch·∫•t (Adj)"
                        ]
                    },
                    {
                        id: 21,
                        options: [{id: "A", text: "in"}, {id: "B", text: "on"}, {id: "C", text: "at"}, {id: "D", text: "to"}],
                        correct: "A",
                        signalElementIds: ["sig-1-21-2"], // "engage"
                        hints: [
                            "Hint 1 (Enemy): Gi·ªõi t·ª´. B√†i t·∫≠p C·∫§U TR√öC/COLLOCATION.",
                            "Hint 2 (Signal): ƒê·ªông t·ª´ 'engage' ƒë·ª©ng tr∆∞·ªõc.",
                            "Hint 3 (Logic): ƒê·ªông t·ª´ 'engage' ƒëi v·ªõi gi·ªõi t·ª´ n√†o ƒë·ªÉ mang nghƒ©a l√† 'tham gia v√†o'?",
                            "Hint 4 (Trans):<br>A. engage + [gi·ªõi t·ª´ A]: tham gia v√†o<br>B. engage + [gi·ªõi t·ª´ B]<br>C. engage + [gi·ªõi t·ª´ C]<br>D. engage + [gi·ªõi t·ª´ D]"
                        ]
                    },
                    {
                        id: 22,
                        options: [{id: "A", text: "awareness"}, {id: "B", text: "supporting"}, {id: "C", text: "investment"}, {id: "D", text: "education"}],
                        correct: "A",
                        signalElementIds: ["sig-1-22-2"], // "enhance ... about"
                        hints: [
                            "Hint 1 (Enemy): Danh t·ª´ kh√°c nghƒ©a. B√†i t·∫≠p T·ª™ V·ª∞NG.",
                            "Hint 2 (Signal): ƒê·ªông t·ª´ 'enhance' (n√¢ng cao) v√† gi·ªõi t·ª´ 'about' ph√≠a sau.",
                            "Hint 3 (Logic): C·ª•m t·ª´ n√†o th∆∞·ªùng ƒëi v·ªõi 'about' ƒë·ªÉ di·ªÖn t·∫£ vi·ªác hi·ªÉu bi·∫øt th√™m v·ªÅ l·ª£i √≠ch c·ªßa vi·ªác t·∫≠p th·ªÉ d·ª•c?",
                            "Hint 4 (Trans):<br>A. s·ª± nh·∫≠n th·ª©c<br>B. s·ª± h·ªó tr·ª£<br>C. s·ª± ƒë·∫ßu t∆∞<br>D. s·ª± gi√°o d·ª•c"
                        ]
                    },
                    {
                        id: 23,
                        options: [{id: "A", text: "And"}, {id: "B", text: "But"}, {id: "C", text: "If"}, {id: "D", text: "Although"}],
                        correct: "C",
                        signalElementIds: ["sig-1-23-2"], // "you want to... keep in touch"
                        hints: [
                            "Hint 1 (Enemy): Li√™n t·ª´. B√†i t·∫≠p C·∫§U TR√öC C√ÇU.",
                            "Hint 2 (Signal): M·ªánh ƒë·ªÅ 'you want to get more involved' v√† m·ªánh ƒë·ªÅ ch·ªâ d·∫´n 'keep in touch'.",
                            "Hint 3 (Logic): X√°c ƒë·ªãnh m·ªëi quan h·ªá gi·ªØa hai v·∫ø: ƒêi·ªÅu ki·ªán - K·∫øt qu·∫£ hay T∆∞∆°ng ph·∫£n?",
                            "Hint 4 (Trans):<br>A. V√†<br>B. Nh∆∞ng<br>C. N·∫øu<br>D. M·∫∑c d√π"
                        ]
                    },
                    {
                        id: 24,
                        options: [{id: "A", text: "a lifestyle healthier"}, {id: "B", text: "a health lifestyle"}, {id: "C", text: "a lifestyle health"}, {id: "D", text: "a healthier lifestyle"}],
                        correct: "D",
                        signalElementIds: ["sig-1-24-1"], // "adopt"
                        hints: [
                            "Hint 1 (Enemy): Tr·∫≠t t·ª± t·ª´ trong C·ª•m danh t·ª´. B√†i t·∫≠p NG·ªÆ PH√ÅP.",
                            "Hint 2 (Signal): ƒê·ªông t·ª´ 'adopt' c·∫ßn m·ªôt t√¢n ng·ªØ (C·ª•m danh t·ª´).",
                            "Hint 3 (Logic): H√£y nh·ªõ l·∫°i tr·∫≠t t·ª± chu·∫©n c·ªßa m·ªôt C·ª•m danh t·ª´ trong ti·∫øng Anh: M·∫°o t·ª´, T√≠nh t·ª´ v√† Danh t·ª´ s·∫Øp x·∫øp nh∆∞ th·∫ø n√†o?",
                            "Hint 4 (Trans):<br>A. M·∫°o t·ª´ + Danh t·ª´ + T√≠nh t·ª´<br>B. M·∫°o t·ª´ + Danh t·ª´ + Danh t·ª´<br>C. M·∫°o t·ª´ + Danh t·ª´ + Danh t·ª´<br>D. M·∫°o t·ª´ + T√≠nh t·ª´ + Danh t·ª´"
                        ]
                    }
                ]
            },
            {
                id: 2,
                title: "Exercise 2: The Benefits of Learning English",
                content: `
                    <h3 style="margin-top:0">The Benefits of Learning English</h3>
                    <p>
                        Firstly, English is the language of international communication. 
                        <span id="gap-2-20" class="gap" onclick="app.selectQuestion(2, 20)">(20) ______</span> 
                        <span id="sig-2-20-2" class="signal-word">you want to travel</span>, 
                        study abroad, or work in a multinational company, knowing English will open up many opportunities.
                    </p>
                    <p>
                        Secondly, English provides access to a vast amount of information. 
                        <span id="gap-2-21" class="gap" onclick="app.selectQuestion(2, 21)">(21) ______</span>, 
                        <span id="sig-2-21-2" class="signal-word">proficiency in English enables you</span> 
                        to stay updated with the latest developments in various fields.
                    </p>
                    <p>
                        Moreover, learning English can enhance your cognitive abilities... 
                        <span id="gap-2-22" class="gap" onclick="app.selectQuestion(2, 22)">(22) ______</span> 
                        <span id="sig-2-22-2" class="signal-word">the process</span> 
                        of acquiring a new language challenges your brain, leading to mental agility.
                    </p>
                    <p>
                        In addition, English is often considered the language of business. 
                        <span id="gap-2-23" class="gap" onclick="app.selectQuestion(2, 23)">(23) ______</span>, 
                        <span id="sig-2-23-2" class="signal-word">having strong English skills</span> 
                        can significantly boost your career prospects.
                    </p>
                    <p>
                        <span id="gap-2-24" class="gap" onclick="app.selectQuestion(2, 24)">(24) ______</span>, 
                        <span id="sig-2-24-2" class="signal-word">learning English is an investment</span> 
                        in yourself. It's a skill that will continue to be valuable throughout your life.
                    </p>
                `,
                questions: [
                    {
                        id: 20,
                        options: [{id: "A", text: "Whether"}, {id: "B", text: "Although"}, {id: "C", text: "Since"}, {id: "D", text: "Despite"}],
                        correct: "A",
                        signalElementIds: ["sig-2-20-2"], // "you want to travel... or..."
                        hints: [
                            "Hint 1 (Enemy): Li√™n t·ª´. B√†i t·∫≠p C·∫§U TR√öC.",
                            "Hint 2 (Signal): H√£y quan s√°t chu·ªói li·ªát k√™ 'travel, study abroad, OR work'.",
                            "Hint 3 (Logic): C·∫•u tr√∫c li√™n t·ª´ n√†o ƒëi v·ªõi 'or' ƒë·ªÉ di·ªÖn t·∫£ s·ª± l·ª±a ch·ªçn gi·ªØa c√°c kh·∫£ nƒÉng?",
                            "Hint 4 (Trans):<br>A. Cho d√π (li·ªáu... hay...)<br>B. M·∫∑c d√π<br>C. B·ªüi v√¨/K·ªÉ t·ª´ khi<br>D. B·∫•t ch·∫•p"
                        ]
                    },
                    {
                        id: 21,
                        options: [{id: "A", text: "In contrast"}, {id: "B", text: "For example"}, {id: "C", text: "However"}, {id: "D", text: "Furthermore"}],
                        correct: "D",
                        signalElementIds: ["sig-2-21-2"], // Logic between sentences
                        hints: [
                            "Hint 1 (Enemy): T·ª´ n·ªëi (Linking words). B√†i t·∫≠p LI√äN K·∫æT C√ÇU.",
                            "Hint 2 (Signal): C√¢u tr∆∞·ªõc n√≥i v·ªÅ 'access info'. C√¢u n√†y n√≥i v·ªÅ 'stay updated'.",
                            "Hint 3 (Logic): X√°c ƒë·ªãnh m·ªëi quan h·ªá gi·ªØa hai c√¢u: √ù sau b·ªï sung th√¥ng tin (t√≠ch c·ª±c) cho √Ω tr∆∞·ªõc hay ƒë·ªëi l·∫≠p?",
                            "Hint 4 (Trans):<br>A. Ng∆∞·ª£c l·∫°i<br>B. V√≠ d·ª•<br>C. Tuy nhi√™n<br>D. H∆°n n·ªØa"
                        ]
                    },
                    {
                        id: 22,
                        options: [{id: "A", text: "Nevertheless"}, {id: "B", text: "Consequently"}, {id: "C", text: "Otherwise"}, {id: "D", text: "In addition"}],
                        correct: "D", 
                        signalElementIds: ["sig-2-22-2"], // "the process... challenges"
                        hints: [
                            "Hint 1 (Enemy): T·ª´ n·ªëi. B√†i t·∫≠p LI√äN K·∫æT.",
                            "Hint 2 (Signal): C√¢u tr∆∞·ªõc n√≥i 'enhanced abilities'. C√¢u n√†y gi·∫£i th√≠ch th√™m v·ªÅ 'mental agility'.",
                            "Hint 3 (Logic): H√£y xem x√©t xem c√¢u n√†y ƒëang ƒë∆∞a ra m·ªôt √Ω t∆∞∆°ng ph·∫£n, m·ªôt h·∫≠u qu·∫£, hay th√™m m·ªôt kh√≠a c·∫°nh b·ªï sung?",
                            "Hint 4 (Trans):<br>A. Tuy nhi√™n<br>B. H·∫≠u qu·∫£ l√†<br>C. N·∫øu kh√¥ng th√¨<br>D. Ngo√†i ra/Th√™m v√†o ƒë√≥"
                        ]
                    },
                    {
                        id: 23,
                        options: [{id: "A", text: "As a result"}, {id: "B", text: "On the other hand"}, {id: "C", text: "Therefore"}, {id: "D", text: "To sum up"}],
                        correct: "C", 
                        signalElementIds: ["sig-2-23-2"], // "having strong English skills... boost career"
                        hints: [
                            "Hint 1 (Enemy): T·ª´ n·ªëi ch·ªâ Nguy√™n nh√¢n - K·∫øt qu·∫£.",
                            "Hint 2 (Signal): C√¢u tr∆∞·ªõc: Doanh nghi·ªáp d√πng ti·∫øng Anh. C√¢u sau: Ti·∫øng Anh t·ªët gi√∫p thƒÉng ti·∫øn.",
                            "Hint 3 (Logic): M·ªëi quan h·ªá gi·ªØa vi·ªác doanh nghi·ªáp d√πng ti·∫øng Anh v√† c∆° h·ªôi thƒÉng ti·∫øn c·ªßa c√° nh√¢n l√† g√¨?",
                            "Hint 4 (Trans):<br>A. K·∫øt qu·∫£ l√†<br>B. M·∫∑t kh√°c<br>C. Do ƒë√≥/V√¨ v·∫≠y<br>D. T√≥m l·∫°i"
                        ]
                    },
                    {
                        id: 24,
                        options: [{id: "A", text: "All are correct"}, {id: "B", text: "All in all"}, {id: "C", text: "The"}, {id: "D", text: "But"}],
                        correct: "B",
                        signalElementIds: ["sig-2-24-2"], // Final paragraph
                        hints: [
                            "Hint 1 (Enemy): C·ª•m t·ª´ k·∫øt b√†i.",
                            "Hint 2 (Signal): ƒê√¢y l√† c√¢u m·ªü ƒë·∫ßu c·ªßa ƒëo·∫°n vƒÉn cu·ªëi c√πng.",
                            "Hint 3 (Logic): C·∫ßn m·ªôt c·ª•m t·ª´ c√≥ ch·ª©c nƒÉng g√¨ ƒë·ªÉ b·∫Øt ƒë·∫ßu ƒëo·∫°n k·∫øt lu·∫≠n?",
                            "Hint 4 (Trans):<br>A. T·∫•t c·∫£ ƒë·ªÅu ƒë√∫ng<br>B. T√≥m l·∫°i/Nh√¨n chung<br>C. (M·∫°o t·ª´)<br>D. Nh∆∞ng"
                        ]
                    }
                ]
            },
            {
                id: 3,
                title: "Exercise 3: A Well-balanced Life",
                content: `
                    <h3 style="margin-top:0">A Well-balanced Life</h3>
                    <p>
                        When I was at school, I had to learn how to have a well-balanced life... Firstly, I managed my time properly. 
                        <span id="gap-3-20" class="gap" onclick="app.selectQuestion(3, 20)">(20) ______</span> 
                        <span id="sig-3-20-2" class="signal-word">started to plan</span> 
                        my schedule, made a weekly work list... This helped me concentrate my efforts.
                    </p>
                    <p>
                        In addition, I communicated with my family... so they would offer me additional 
                        <span id="gap-3-21" class="gap" onclick="app.selectQuestion(3, 21)">(21) ______</span>.
                        <span id="sig-3-21-prev" class="signal-word" style="display:none">additional</span>
                    </p>
                    <p>
                        I also took breaks appropriately... and gave my brain a rest and improved my 
                        <span id="gap-3-22" class="gap" onclick="app.selectQuestion(3, 22)">(22) ______</span>.
                    </p>
                    <p>
                        Finally, I looked after my 
                        <span id="gap-3-23" class="gap" onclick="app.selectQuestion(3, 23)">(23) ______</span>. 
                        I got at least eight hours of sleep a day. I played football... and went for a walk...
                    </p>
                    <p>
                        Besides, I also tried to 
                        <span id="gap-3-24" class="gap" onclick="app.selectQuestion(3, 24)">(24) ______</span> 
                        <span id="sig-3-24-2" class="signal-word">a healthy diet</span>: 
                        eating a lot of fruit and vegetables...
                    </p>
                `,
                questions: [
                    {
                        id: 20,
                        options: [{id: "A", text: "however"}, {id: "B", text: "therefore"}, {id: "C", text: "but"}, {id: "D", text: "because"}],
                        correct: "B", 
                        signalElementIds: ["sig-3-20-2"], // "started to plan"
                        hints: [
                            "Hint 1 (Enemy): T·ª´ n·ªëi (Connectors).",
                            "Hint 2 (Signal): H√†nh ƒë·ªông 'managed time' (qu·∫£n l√Ω th·ªùi gian) v√† h√†nh ƒë·ªông c·ª• th·ªÉ 'started to plan' (l√™n k·∫ø ho·∫°ch).",
                            "Hint 3 (Logic): M·ªëi quan h·ªá gi·ªØa vi·ªác qu·∫£n l√Ω th·ªùi gian v√† h√†nh ƒë·ªông b·∫Øt ƒë·∫ßu l√™n k·∫ø ho·∫°ch l√† g√¨ (nguy√™n nh√¢n, k·∫øt qu·∫£, hay t∆∞∆°ng ph·∫£n)?",
                            "Hint 4 (Trans):<br>A. tuy nhi√™n<br>B. v√¨ v·∫≠y/do ƒë√≥<br>C. nh∆∞ng<br>D. b·ªüi v√¨"
                        ]
                    },
                    {
                        id: 21,
                        options: [{id: "A", text: "a"}, {id: "B", text: "the"}, {id: "C", text: "some"}, {id: "D", text: "No article"}],
                        correct: "C", 
                        signalElementIds: [], // Implicit noun
                        hints: [
                            "Hint 1 (Enemy): L∆∞·ª£ng t·ª´/M·∫°o t·ª´.",
                            "Hint 2 (Signal): C·ª•m 'offer me additional...'. ·ªû ƒë√¢y c√≥ m·ªôt danh t·ª´ ·∫©n (v√≠ d·ª•: help/support).",
                            "Hint 3 (Logic): N·∫øu danh t·ª´ ·∫©n l√† 'help/support' (kh√¥ng ƒë·∫øm ƒë∆∞·ª£c), l∆∞·ª£ng t·ª´ n√†o ph√π h·ª£p trong c√¢u kh·∫≥ng ƒë·ªãnh?",
                            "Hint 4 (Trans):<br>A. m·ªôt (d√πng cho s·ªë √≠t ƒë·∫øm ƒë∆∞·ª£c)<br>B. ·∫•y (x√°c ƒë·ªãnh)<br>C. m·ªôt v√†i/m·ªôt ch√∫t<br>D. kh√¥ng m·∫°o t·ª´"
                        ]
                    },
                    {
                        id: 22,
                        options: [{id: "A", text: "happy"}, {id: "B", text: "happier"}, {id: "C", text: "happiness"}, {id: "D", text: "happily"}],
                        correct: "C",
                        signalElementIds: [], 
                        hints: [
                            "Hint 1 (Enemy): T·ª´ lo·∫°i (Word Form).",
                            "Hint 2 (Signal): T√≠nh t·ª´ s·ªü h·ªØu 'my' ƒë·ª©ng tr∆∞·ªõc.",
                            "Hint 3 (Logic): Theo quy t·∫Øc ng·ªØ ph√°p, lo·∫°i t·ª´ n√†o b·∫Øt bu·ªôc ph·∫£i ƒë·ª©ng sau t√≠nh t·ª´ s·ªü h·ªØu (my, your, his...)?",
                            "Hint 4 (Trans):<br>A. vui v·∫ª (Adj)<br>B. vui h∆°n (Adj)<br>C. ni·ªÅm vui/h·∫°nh ph√∫c (Noun)<br>D. m·ªôt c√°ch vui v·∫ª (Adv)"
                        ]
                    },
                    {
                        id: 23,
                        options: [{id: "A", text: "healthy diet"}, {id: "B", text: "junk foods"}, {id: "C", text: "physical health"}, {id: "D", text: "mood"}],
                        correct: "C",
                        signalElementIds: [], 
                        hints: [
                            "Hint 1 (Enemy): T·ª´ v·ª±ng theo ng·ªØ c·∫£nh.",
                            "Hint 2 (Signal): C√°c ho·∫°t ƒë·ªông li·ªát k√™ sau ƒë√≥: 'sleep' (ng·ªß), 'play football' (ƒë√° b√≥ng), 'walk' (ƒëi b·ªô).",
                            "Hint 3 (Logic): C√°c ho·∫°t ƒë·ªông ng·ªß v√† th·ªÉ thao ph·ª•c v·ª• cho kh√≠a c·∫°nh n√†o c·ªßa con ng∆∞·ªùi?",
                            "Hint 4 (Trans):<br>A. ch·∫ø ƒë·ªô ƒÉn<br>B. ƒë·ªì ƒÉn v·∫∑t<br>C. s·ª©c kh·ªèe th·ªÉ ch·∫•t<br>D. t√¢m tr·∫°ng"
                        ]
                    },
                    {
                        id: 24,
                        options: [{id: "A", text: "take part"}, {id: "B", text: "healthy diet"}, {id: "C", text: "be careful"}, {id: "D", text: "make sure"}],
                        correct: "D", 
                        signalElementIds: ["sig-3-24-2"], // "a healthy diet"
                        hints: [
                            "Hint 1 (Enemy): C·ª•m ƒë·ªông t·ª´.",
                            "Hint 2 (Signal): T√¢n ng·ªØ 'a healthy diet' (ch·∫ø ƒë·ªô ƒÉn l√†nh m·∫°nh).",
                            "Hint 3 (Logic): Ch√∫ng ta c·∫ßn t·ª´ mang nghƒ©a 'duy tr√¨' ho·∫∑c 'ƒë·∫£m b·∫£o' m·ªôt ch·∫ø ƒë·ªô ƒÉn. (L∆∞u √Ω: 'take part' c·∫ßn gi·ªõi t·ª´ g√¨?)",
                            "Hint 4 (Trans):<br>A. tham gia (thi·∫øu 'in')<br>B. (l·∫∑p t·ª´)<br>C. c·∫©n th·∫≠n<br>D. ƒë·∫£m b·∫£o/duy tr√¨"
                        ]
                    }
                ]
            }
        ];

        // --- CONTROLLER (LOGIC APP) ---
        const app = {
            state: {
                currentExIndex: 0,
                currentScore: 0,
                maxScore: 0, 
                questionsMap: {}, 
            },

            // 1. PASSWORD CHECK
            checkPassword: function() {
                const pass = document.getElementById('password-input').value;
                if (pass === "1234") {
                    document.getElementById('password-overlay').style.display = 'none';
                    document.getElementById('main-container').classList.add('visible');
                    this.initExercise(0);
                } else {
                    document.getElementById('pass-error').style.display = 'block';
                }
            },

            // 2. KH·ªûI T·∫†O B√ÄI T·∫¨P
            initExercise: function(index) {
                if (index >= exercises.length) {
                    alert("Ch√∫c m·ª´ng! B·∫°n ƒë√£ ho√†n th√†nh t·∫•t c·∫£ b√†i t·∫≠p.");
                    return;
                }

                this.state.currentExIndex = index;
                const exData = exercises[index];

                // C·∫≠p nh·∫≠t giao di·ªán Text
                document.getElementById('ex-title').innerText = exData.title;
                document.getElementById('ex-content').innerHTML = exData.content;
                document.getElementById('game-area').innerHTML = '<div style="text-align:center; color:#888; padding:20px;">Ch·ªçn m·ªôt √¥ tr·ªëng (v√≠ d·ª•: 20, 21) trong vƒÉn b·∫£n ƒë·ªÉ b·∫Øt ƒë·∫ßu.</div>';
                
                // N√∫t Next
                const btn = document.getElementById('next-ex-btn');
                btn.style.display = 'none';

                // Reset map c√¢u h·ªèi cho b√†i m·ªõi
                exData.questions.forEach(q => {
                    const uniqueKey = `${index}-${q.id}`;
                    if(!this.state.questionsMap[uniqueKey]) {
                        this.state.questionsMap[uniqueKey] = {
                            answered: false,
                            points: 5,
                            hintsOpened: [false, false, false, false],
                            userAnswer: null
                        };
                        this.state.maxScore += 5;
                    }
                });
                
                this.updateScoreDisplay();
            },

            // 3. CH·ªåN C√ÇU H·ªéI
            selectQuestion: function(exId, qId) {
                const realExIndex = exId - 1; 
                
                // Highlight gap
                document.querySelectorAll('.gap').forEach(el => el.classList.remove('active'));
                const activeGap = document.getElementById(`gap-${exId}-${qId}`);
                if(activeGap) activeGap.classList.add('active');

                this.renderGamePanel(realExIndex, qId);
            },

            // 4. RENDER B·∫¢NG C√ÇU H·ªéI
            renderGamePanel: function(exIndex, qId) {
                const exData = exercises[exIndex];
                const qData = exData.questions.find(q => q.id === qId);
                const uniqueKey = `${exIndex}-${qId}`;
                const qState = this.state.questionsMap[uniqueKey];
                const panel = document.getElementById('game-area');

                if (!qData) return;

                // X·ª≠ l√Ω logic Hint 2 (Highlight l·∫°i n·∫øu ƒë√£ m·ªü)
                document.querySelectorAll('.signal-word').forEach(el => el.classList.remove('highlighted'));
                if (qState.hintsOpened[1]) { 
                    qData.signalElementIds.forEach(id => {
                         const el = document.getElementById(id);
                         if(el) el.classList.add('highlighted');
                    });
                }

                let html = `
                    <div class="current-q-info">
                        <div style="font-weight:bold; margin-bottom:5px;">Question ${qId}</div>
                        <div style="font-size:0.9rem; color:#666;">
                            ƒêi·ªÉm: <b style="color:${qState.answered ? (qState.points > 0 ? 'var(--success-color)' : 'var(--error-color)') : 'var(--primary-color)'}">
                                ${qState.answered ? (qState.points > 0 ? '+' + qState.points : '0') : qState.points}
                            </b>
                        </div>
                    </div>

                    <div class="options-grid">
                        ${qData.options.map(opt => {
                            let btnClass = 'option-btn';
                            let disabled = '';
                            if (qState.answered) {
                                disabled = 'disabled';
                                if (opt.id === qData.correct) btnClass += ' reveal-correct';
                                if (opt.id === qState.userAnswer) {
                                    btnClass += (opt.id === qData.correct) ? ' correct-select' : ' wrong-select';
                                }
                            }
                            return `<button class="${btnClass}" ${disabled} onclick="app.submitAnswer(${exIndex}, ${qId}, '${opt.id}')">${opt.id}. ${opt.text}</button>`;
                        }).join('')}
                    </div>

                    <div class="hints-container">
                        <div style="font-size:0.9rem; font-weight:bold; margin-bottom:5px; color:#555;">G·ª£i √Ω (M·ªü theo th·ª© t·ª±):</div>
                        ${qData.hints.map((hintText, index) => {
                            const isOpened = qState.hintsOpened[index];
                            const isLocked = index > 0 && !qState.hintsOpened[index - 1];
                            const disabledAttr = (qState.answered || isLocked) && !isOpened ? 'disabled' : '';

                            return `
                                <div class="hint-item">
                                    <button class="hint-btn" ${disabledAttr} onclick="app.openHint(${exIndex}, ${qId}, ${index})">
                                        <span>${isOpened ? 'üìñ Hint ' + (index+1) : (isLocked ? 'üîí Locked' : 'üîê M·ªü Hint ' + (index+1))}</span>
                                        <span class="hint-cost">${isOpened || qState.answered ? '' : '-1 Point'}</span>
                                    </button>
                                    <div class="hint-content ${isOpened ? 'show' : ''}">${hintText}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                panel.innerHTML = html;
            },

            // 5. X·ª¨ L√ù HINT
            openHint: function(exIndex, qId, hintIndex) {
                const uniqueKey = `${exIndex}-${qId}`;
                const qState = this.state.questionsMap[uniqueKey];
                
                if (hintIndex > 0 && !qState.hintsOpened[hintIndex - 1]) {
                    alert("B·∫°n ph·∫£i m·ªü g·ª£i √Ω tr∆∞·ªõc ƒë√≥ tr∆∞·ªõc!");
                    return;
                }
                
                if (!qState.answered && !qState.hintsOpened[hintIndex]) {
                    if (qState.points > 0) qState.points -= 1;
                    qState.hintsOpened[hintIndex] = true;
                    this.renderGamePanel(exIndex, qId);
                }
            },

            // 6. X·ª¨ L√ù TR·∫¢ L·ªúI
            submitAnswer: function(exIndex, qId, selectedOptId) {
                const uniqueKey = `${exIndex}-${qId}`;
                const qState = this.state.questionsMap[uniqueKey];
                const exData = exercises[exIndex];
                const qData = exData.questions.find(q => q.id === qId);

                if (qState.answered) return;

                qState.userAnswer = selectedOptId;
                qState.answered = true;

                // ID gap trong HTML: gap-{exIndex+1}-{qId}
                const gapEl = document.getElementById(`gap-${exIndex + 1}-${qId}`);
                const correctText = qData.options.find(o => o.id === qData.correct).text;

                if (selectedOptId === qData.correct) {
                    this.state.currentScore += qState.points;
                    gapEl.classList.add('correct');
                    gapEl.classList.remove('wrong');
                    gapEl.innerText = correctText;
                } else {
                    qState.points = 0;
                    gapEl.classList.add('wrong');
                    gapEl.innerText = correctText;
                }

                this.updateScoreDisplay();
                this.renderGamePanel(exIndex, qId);
                this.checkExerciseCompletion(exIndex);
            },

            // 7. KI·ªÇM TRA HO√ÄN TH√ÄNH B√ÄI
            checkExerciseCompletion: function(exIndex) {
                const exData = exercises[exIndex];
                const allAnswered = exData.questions.every(q => {
                    const key = `${exIndex}-${q.id}`;
                    return this.state.questionsMap[key] && this.state.questionsMap[key].answered;
                });
                
                if (allAnswered) {
                    const btn = document.getElementById('next-ex-btn');
                    if (exIndex < exercises.length - 1) {
                        btn.style.display = 'block';
                        btn.innerText = "Chuy·ªÉn sang b√†i ti·∫øp theo ‚û°";
                    } else {
                        btn.style.display = 'block';
                        btn.innerText = "HO√ÄN TH√ÄNH T·∫§T C·∫¢";
                        btn.onclick = () => alert("B·∫°n ƒë√£ ho√†n th√†nh 3 b√†i Cloze Test! T·ªïng ƒëi·ªÉm: " + this.state.currentScore + "/" + this.state.maxScore);
                    }
                }
            },

            nextExercise: function() {
                this.initExercise(this.state.currentExIndex + 1);
            },

            updateScoreDisplay: function() {
                document.getElementById('current-score').innerText = this.state.currentScore;
                document.getElementById('max-score').innerText = this.state.maxScore;
            }
        };
    </script>
</body>
</html>
